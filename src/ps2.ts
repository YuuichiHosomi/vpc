// Virtual PS/2

import { WorkerInterface, RuntimeEnvironment } from './env';
// import { IOManager } from './iomgr';

const SCAN_DUMMY = 0x6F;

const codeTable: { [key: string]: number } = {
    'AltLeft': 0x38,
    'AltRight': 0xE038,
    'ControlLeft': 0x1D,
    'ControlRight': 0xE01D,
    'ShiftLeft': 0x2A,
    'ShiftRight': 0x36,
    'Escape': 0x01,
    'Digit1': 0x02,
    'Digit2': 0x03,
    'Digit3': 0x04,
    'Digit4': 0x05,
    'Digit5': 0x06,
    'Digit6': 0x07,
    'Digit7': 0x08,
    'Digit8': 0x09,
    'Digit9': 0x0A,
    'Digit0': 0x0B,
    'Minus': 0x0C,
    'Equal': 0x0D,
    'Backspace': 0x0E,
    'Tab': 0x0F,
    'BracketLeft': 0x1A,
    'BracketRight': 0x1B,
    'Enter': 0x1C,
    'Semicolon': 0x27,
    'Quote': 0x28,
    'Backquote': 0x29,
    'Backslash': 0x2B,
    'Comma': 0x33,
    'Period': 0x34,
    'Slash': 0x35,
    'Space': 0x39,
    'F1': 0x3B,
    'F2': 0x3C,
    'F3': 0x3D,
    'F4': 0x3E,
    'F5': 0x3F,
    'F6': 0x40,
    'F7': 0x41,
    'F8': 0x42,
    'F9': 0x43,
    'F10': 0x44,
    'Home': 0xE047,
    'ArrowUp': 0xE048,
    'PageUp': 0xE049,
    'ArrowLeft': 0xE04B,
    'ArrowRight': 0xE04D,
    'End': 0xE04F,
    'ArrowDown': 0xE050,
    'Insert': 0xE052,
    'Delete': 0xE053,
    'IntlRo': 0x73,
    'IntlYen': 0x7D,
    'KeyA': 0x1E,
    'KeyB': 0x30,
    'KeyC': 0x2E,
    'KeyD': 0x20,
    'KeyE': 0x12,
    'KeyF': 0x21,
    'KeyG': 0x22,
    'KeyH': 0x23,
    'KeyI': 0x17,
    'KeyJ': 0x24,
    'KeyK': 0x25,
    'KeyL': 0x26,
    'KeyM': 0x32,
    'KeyN': 0x31, 
    'KeyO': 0x18,
    'KeyP': 0x19,
    'KeyQ': 0x10,
    'KeyR': 0x13,
    'KeyS': 0x1f,
    'KeyT': 0x14,
    'KeyU': 0x16,
    'KeyV': 0x2f,
    'KeyW': 0x11,
    'KeyX': 0x2d,
    'KeyY': 0x15,
    'KeyZ': 0x2c,
};

const scanTable: number[] = [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x0f, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00,
    0x2a, 0x1d, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x39, 0x00, 0x00, 0x00, 0x00, 0x4b, 0x48, 0x4d, 0x50, 0x00, 0x00, 0x00, 0x00, 0x52, 0x53, 0x00,
    0x0b, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x1e, 0x30, 0x2e, 0x20, 0x12, 0x21, 0x22, 0x23, 0x17, 0x24, 0x25, 0x26, 0x32, 0x31, 0x18,
    0x19, 0x10, 0x13, 0x1f, 0x14, 0x16, 0x2f, 0x11, 0x2d, 0x15, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3b, 0x3c, 0x3d, 0x3e, 0x3f, 0x40, 0x41, 0x42, 0x43, 0x44, 0x57, 0x58, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x6f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f,
    0x6f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6f, 0x6f, 0x6f, 0x6f, 0x00,
    0x00, 0x00, 0x6f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
];

export class PS2 {
    private env: RuntimeEnvironment;
    private lastCmd: number = 0;
    private iram: Uint8Array;
    private o_fifo: number[];
    private i_fifo: number[];
    private toggle_value: number = 0;

    constructor (env: RuntimeEnvironment) {
        this.env = env;
        this.iram = new Uint8Array(32);
        this.o_fifo = [];
        this.i_fifo = [];

        env.iomgr.on(0x0060, (_, data) => this.data(data), (_) => this.o_fifo.shift() || 0);
        env.iomgr.on(0x0061, undefined, (_) => this.toggle());
        env.iomgr.on(0x0064, (_, data) => this.command(data), (_) => {
            return ((this.o_fifo.length > 0) ? 1 : 0)
        });
        env.iomgr.onw(0x64, undefined, (_) => this.o_fifo.shift() || 0);
    }
    private toggle(): number {
        this.toggle_value ^= 0x10;
        return this.toggle_value;
    }
    private command(data: number): void {
        this.lastCmd = data;
        // console.log(`ps2: command ${data.toString(16)}`);
    }
    private data(data: number): void {
        // console.log(`ps2: data ${data.toString(16)}`);
        // this.postKeyData(0xFA);
    }
    private postKeyData(data: number): void {
        this.o_fifo.push(data);
        this.env.pic.raiseIRQ(1);
    }
    onKey(e: any): void {
        const { type, key, code, keyCode, ctrlKey, altKey } = e;
        let prefix: number = 0;
        let scancode: number = codeTable[code] || scanTable[keyCode] || 0;
        if (scancode > 0x100) {
            prefix = scancode >> 8;
            scancode &= 0x7F;
        }
        let ascii: number = (key.length === 1) ? key.charCodeAt(0) : 0;
        if (ascii === 0xA5) ascii = 0x5C; // IntlYen
        if (ascii >= 0x80) ascii = 0;
        if (ctrlKey && ascii >= 0x40 && ascii <= 0x80) {
            ascii &= 0x1F;
        }
        if (ascii) {
            scancode |= (ascii << 8);
        } else {
            switch (keyCode) {
            case 0x08:
            case 0x09:
            case 0x0D:
            case 0x1B:
                    scancode |= (keyCode << 8);
                break;
            }
        }
        if (altKey) {
            scancode &= 0x7F;
        }

        if (scancode === 0 && ascii !== 0) {
            scancode = SCAN_DUMMY;
        }

        switch (type) {
        case 'keydown':
            break;
        case 'keyup':
            scancode |= 0x80;
            break;
        }

        // console.log('key', e, scancode.toString(16));
        if (scancode & 0x7F) {
            if (prefix) {
                this.postKeyData(prefix);
            }
            this.postKeyData(scancode);
        }
    }
}
