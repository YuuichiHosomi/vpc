<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=720">
    <title>Virtual Playground</title>
    <script src="lib/xterm.js"></script>
    <link rel="stylesheet" href="lib/xterm.css">
    <style>
        html, body {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
        }
        #screen_container {
            display: none;
            cursor: text;
            max-width: 720px;
            min-width: 640px;
            min-height: 400px;
        }
        
        #click_to_start {
            background: #EEE;
            color: #777;
            width: 720px;
            line-height: 400px;
            text-align: center;
            cursor: pointer;
        }
        
        #click_to_start p {
            margin: 0;
            display: inline-block;
            vertical-align: middle;
        }

        #controlPanel {
            width: 720px;
            min-height: 2em;
            margin: 0;
            padding: 0;
            background: #F7F7F7;
        }
        
        address {
            width: 720px;
            margin: 1em 0;
            text-align: right;
            font-size: smaller;
            font-style: normal;
            color: #999;
        }

        address a {
            color: inherit;
            text-decoration: none;
            font-weight: bold;
        }
        address a:hover {
            text-decoration: underline;
        }

        .left {
            float: left;
        }

        summary {
            float: right;
            margin: 2px 8px;
            padding: 0 4px;
            background: #FFF;
            border: #AAA solid 1px;
            border-radius: 4px;
            font-size: 10pt;
            cursor: pointer;
        }

        details article {
            display: block;
            clear: both;
            padding: 8px 1em;
        }

        address {
            clear: both;
        }

        #terminal2 {
            position: absolute;
            width: 320px;
            height: 240px;
            border: none;
            color: transparent;
            background: transparent;
        }
    </style>
    <script>
        const startEmu = () => {
            document.querySelector('#screen_container').style.display = 'block';
            document.querySelector('#click_to_start').style.display = 'none';
            
            const canvasVGA = document.querySelector('#canvasVGA');
            
            if (canvasVGA) {
                const ctx = canvasVGA.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 640, 480);
            }

            if (window.beep) {
                window.beep.createAudioContext();
            }

            const term = new Terminal({convertEol: true, rendererType: 'canvas'});
            term.open(document.querySelector('#terminal'));
            window.term = term;
            term.onKey((e) => {
                window.worker.postMessage({command: 'key', data: e.key.charCodeAt(0) });
            });
            term.focus();
            
            // const term = document.querySelector('#terminal2');
            // term.write = function (message) {
            //     this.value += message;
            //     this.scrollTop = this.scrollHeight;
            // }
            // term.addEventListener('keydown', e => {
            //     e.preventDefault();
            //     console.log(e);
            //     if (e.key.length > 1) {
            //         window.worker.postMessage({command: 'key', data: e.keyCode });
            //     } else {
            //         window.worker.postMessage({command: 'key', data: e.key.charCodeAt(0) });
            //     }
            // });
            // window.term = term;

            setTimeout(startSecond, 100);
        }

        const startSecond = () => {

            const worker = new Worker('lib/worker.js');
            window.worker = worker;
            
            worker.onmessage = message => {
                switch (message.data.command) {
                    case 'loaded':
                    {
                        const gen = parseInt(document.querySelector('#selCpuGen').value);
                        window.worker.postMessage(
                            { command: 'start',
                            gen: gen,
                            imageName: document.querySelector('#selDiskImage').value,
                            ioRedirectMap: iomgr.ioRedirectMap }
                            );
                        break;
                    }
                    case 'write':
                        window.term.write(message.data.data);
                        break;
                    case 'outb':
                        window.iomgr.outb(message.data.data.port, message.data.data.data);
                        break;
                    case 'beep':
                        window.beep.sound(message.data.data);
                        break;
                    default:
                        throw message;
                }
            };
        }
        
        // Renderer I/O Manager
        class FrontendIOManager {
            constructor () {
                this.ioMap = [];
                this.ioRedirectMap = new Uint32Array(2048);
            }
            on (port, callback) {
                this.ioMap[port & 0xFFFF] = callback;
                this.ioRedirectMap[port >> 5] |= (1 << (port & 31));
            }
            outb (port, data) {
                try {
                    const handler = this.ioMap[port & 0xFFFF];
                    if (handler) {
                        handler(port, data | 0);
                    } else {
                        throw Error(`front_outb(): Unexpected port $0x${port.toString(16)}`);
                    }
                } catch (e) {
                    console.error('front_outb()', e);
                }
            }
        }
        window.iomgr = new FrontendIOManager();
        
        // i8254 Beep Sound Driver
        class i8254Sound {
            constructor () {
                this.audioContext = window.AudioContext || window.webkitAudioContext;
                if (!this.audioContext) return;
                this.context = null;
                this.src = null;
                
                document.querySelector('#volumeControl').style.display = 'inline-block';
                document.querySelector('#inputVolume').addEventListener('change', e => {
                    if (this.gain) {
                        this.gain.gain.value = this.getGain();
                    }
                });
            }
            createAudioContext () {
                this.context = new this.audioContext();
                this.context.createOscillator();
            }
            sound(value) {
                this.noteOff();
                if (value > 0) {
                    this.noteOn(value);
                }
            }
            noteOn(freq) {
                // this.noteOff();
                
                this.gain = this.context.createGain();
                this.gain.gain.value = this.getGain();
                
                this.src = this.context.createOscillator();
                this.src.type = 'square';
                this.src.frequency.value = freq;
                this.src.connect(this.gain);
                this.gain.connect(this.context.destination);
                this.src.start(0);
            }
            noteOff() {
                if (this.src) {
                    this.src.disconnect();
                }
                this.src = null;
                this.gain = null;
            }
            getGain() {
                const val = document.querySelector('#inputVolume').value;
                return val * 2 / 100;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            window.beep = new i8254Sound();
            document.querySelector('#click_to_start').addEventListener('click', e => {
                if (!window.WebAssembly) {
                    alert("We are sorry, but WebAssembly is not supported.");
                    return;
                }
                startEmu();
            });

            document.querySelector('#buttonNMI').addEventListener('click', e => {
                if (window.worker) {
                    worker.postMessage({command: 'nmi' });
                }
            });
            document.querySelector('#buttonDump').addEventListener('click', e => {
                const rawValue = document.querySelector('#inputAddress').value;
                let address = 0;
                if (rawValue.indexOf(':') > 0) {
                    const pair = rawValue.split(':');
                    address = (parseInt(`0x${pair[0]}`) << 4) + (parseInt(`0x${pair[1]}`));
                } else {
                    address = parseInt(`0x0${rawValue}`);
                }
                if (window.worker) {
                    worker.postMessage({command: 'dump', address: address})
                }
            })
            document.querySelector('#buttonUpload').addEventListener('click', e => {
                document.querySelector('#fileUpload').click();
            });
        });
        
</script>
</head>
<body>
    <div id="emulatorFrame">
        <div id="screen_container">
            <!-- <textarea id="terminal2"></textarea>
            <canvas id="canvasVGA" width="320" height="240"></canvas> -->
            <p></p>
            <div id="terminal"></div>
        </div>
        <div id="click_to_start"><p>CLICK TO START</p></div>
    </div>

    <div id="controlPanel">
        <label id="volumeControl" style="display: none;" class="left">
            &#x1F64A;<input id="inputVolume" type="range" min="0" max="10" step="1" value="5">&#x1F50A;
        </label>
        <details>
            <summary>Option</summary>
            <article>
                <p>
                        &#x1f4be; Disk:
                    <label>
                        Preset:
                        <select id="selDiskImage">
                            <option value="../bin/osz.img" selected>osz</option>
                            <option value="../var/PCDOS090.img">PCDOS 0.9</option>
                            <option value="../var/PCDOS100.img">PCDOS 1.0</option>
                            <option value="../var/PCDOS200.img">PCDOS 2.0</option>
                            <option value="../var/fdos.img">FreeDOS</option>
                            <option value="../var/elks.img">elks</option>
                        </select>
                        <input id="buttonUpload" type="button" value="Attach" disabled>
                        <input id="fileUpload" type="file" style="width:0px; height:0px;">
                    </label>
                </p>

                <p>
                    <label>
                        CPU:
                        <select id="selCpuGen">
                            <option value="0">8086</option>
                            <option value="1">80186</option>
                            <option value="2">80286</option>
                            <option value="3">80386</option>
                            <option value="4" selected>486SX</option>
                        </select>
                    </label>
                </p>

                <div>
                    &#x1F41B; Debug:
                    <input id="buttonNMI" type="button" value="NMI">
                    <input id="inputAddress" value="" placeholder="0000:0000" size="12">
                    <input id="buttonDump" type="submit" value="Dump">
                </div>
            </article>
        </details>
    </div>

    <address>
        POWERED by 
        <a href="https://github.com/neri/vpc">Virtual Playground</a>
        <!-- / <a href="https://github.com/xtermjs/xterm.js/">xterm.js</a> -->
    </address>
</body>
</html>
