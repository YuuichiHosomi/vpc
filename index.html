<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=720">
    <title>Virtual Playground</title>
    <script src="lib/xterm.js"></script>
    <link rel="stylesheet" href="lib/xterm.css">
    <style>
        :root {
            --main-screen-width: 720px;
            --main-screen-height: 400px;
        }
        html, body {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
            -webkit-user-select: none;
        }
        #screen_container {
            display: none;
            cursor: text;
            width: var(--main-screen-width);
            min-height: var(--main-screen-height);
        }
        
        #click_to_start {
            background: #EEE;
            color: #777;
            width: var(--main-screen-width);
            line-height: var(--main-screen-height);
            text-align: center;
            cursor: pointer;
        }
        
        #click_to_start p {
            margin: 0;
            display: inline-block;
            vertical-align: middle;
        }

        #controlPanel {
            width: var(--main-screen-width);
            min-height: 2em;
            margin: 0;
            padding: 0;
            background: #F7F7F7;
        }
        
        .controlFrame {
            display: inline-block;
            margin: 1px 3px;
            padding: 1px 3px;
            background: rgba(0, 0, 0, 0.125);
            border-radius: 8px;
            min-height: 24px;
            vertical-align: middle;
            border: transparent dashed 2px;
            font-size: 14px;
        }

        .controlActive {
            border-color: #00F;
        }

        #volumeControl {
            display: none;
        }

        address {
            width: var(--main-screen-width);
            margin: 1em 0;
            text-align: right;
            font-size: smaller;
            font-style: normal;
            color: #999;
        }

        address a {
            color: inherit;
            text-decoration: none;
            font-weight: bold;
        }
        address a:hover {
            text-decoration: underline;
        }

        .left {
            float: left;
        }

        summary {
            float: right;
            margin: 4px 8px;
        }

        details article {
            display: block;
            clear: both;
            padding: 8px 1em;
        }

        address {
            clear: both;
        }

        #terminal2 {
            position: absolute;
            margin: 0;
            padding: 0;
            width: 640px;
            height: 400px;
            border: none;
            color: transparent;
            background: transparent;
        }
        
        .buttonFace {
            display: inline-block;
            padding: 0 12px;
            min-height: 16px;
            vertical-align: middle;
            font-size: 12px;
            border: none;
            background: #9E9E9E;
            color: #FFF;
            border-radius: 4px;
            cursor: pointer;
        }

        .buttonFace:hover {
            box-shadow: 1px 1px 4px 2px rgba(0, 0, 0, 0.125);
        }
        
        .activeButton {
            background: #2196F3;
        }
        
        .destructiveButton {
            background: #F44336;
        }

        input[type=text] {
            border: #AAA dashed 1px;
            background: transparent;
        }

        #midiMode {
            font-weight: bold;
        }

    </style>
    <script>

        const $ = x => document.querySelector(x);

        const startEmu = () => {
            $('#screen_container').style.display = 'block';
            $('#click_to_start').style.display = 'none';
            
            const canvasVGA = $('#canvasVGA');
            
            if (canvasVGA) {
                const ctx = canvasVGA.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 640, 480);
            }

            if (window.beep) {
                window.beep.createAudioContext();
            }

if (true) {

            const term = new Terminal({convertEol: true, rendererType: 'canvas'});
            term.open($('#terminal'));
            window.term = term;
            term.onKey((e) => {
                let keyCode = e.key.charCodeAt(0);
                if (keyCode == 127) keyCode = 8; // BS
                window.worker.postMessage({command: 'key', data: keyCode });
            });
            term.focus();

} else {

            const term = $('#terminal2');
            term.write = function (message) {
                this.value += message;
                this.scrollTop = this.scrollHeight;
            }
            term.addEventListener('keydown', e => {
                e.preventDefault();
                if (e.key.length > 1) {
                    window.worker.postMessage({command: 'key', data: e.keyCode });
                } else {
                    window.worker.postMessage({command: 'key', data: e.key.charCodeAt(0) });
                }
            });
            window.term = term;

}

            setTimeout(startSecond, 100);
        }

        const startSecond = () => {

            const worker = new Worker('lib/worker.js');
            window.worker = worker;
            
            worker.onmessage = message => {
                switch (message.data.command) {
                    case 'loaded':
                    {
                        let cmd = { command: 'start',
                            gen: parseInt($('#selCpuGen').value),
                            mem: parseInt($('#selMemory').value),
                        };
                        $('#selMemory').disabled = true;
                        if (window.attach) {
                            window.worker.postMessage({command: 'attach', blob: window.attach});
                            window.attach = undefined;
                        } else {
                            const image = $('#selDiskImage').value;
                            if (image) {
                                cmd.imageName = image;
                            }
                        }
                        window.worker.postMessage(iomgr.connect(cmd));
                        break;
                    }
                    case 'write':
                        window.term.write(message.data.data);
                        break;
                    case 'alert':
                        alert(message.data.data);
                        break;
                    case 'regResult':
                        $('#inputRegister').value = message.data.data;
                        break;
                    default:
                        window.iomgr.dispatchMessage(message.data.command, message.data.data);
                }
            };
        }
        
        // Renderer I/O Manager
        class FrontendIOManager {
            constructor () {
                this.ioMap = [];
                this.ioRedirectMap = new Uint32Array(2048);
                this.msgMap = {};
                this.connectMap = {};
                this.onCommand('outb', data => {
                    this.outb(data.port, data.data)
                });
            }
            on (port, callback) {
                this.ioMap[port & 0xFFFF] = callback;
                this.ioRedirectMap[port >> 5] |= (1 << (port & 31));
            }
            onCommand (command, callback) {
                this.msgMap[command] = callback;
            }
            onConnect (name, data) {
                this.connectMap[name] = data;
            }
            outb (port, data) {
                try {
                    const handler = this.ioMap[port & 0xFFFF];
                    if (handler) {
                        handler(port, data | 0);
                    } else {
                        throw Error(`front_outb(): Unexpected port $0x${port.toString(16)}`);
                    }
                } catch (e) {
                    console.error('front_outb()', e);
                }
            }
            connect (map) {
                this.connectMap.ioRedirectMap = this.ioRedirectMap;
                return Object.assign(map, this.connectMap);
            }
            dispatchMessage(command, data) {
                const callback = this.msgMap[command];
                if (callback) {
                    callback(data);
                } else {
                    throw new Error(`Unknown command: ${command}`);
                }
            }
        }
        window.iomgr = new FrontendIOManager();
        
        // i8254 Beep Sound Driver
        class i8254Sound {
            constructor (iomgr) {
                this.audioContext = window.AudioContext || window.webkitAudioContext;
                if (!this.audioContext) return;
                this.context = null;
                this.src = null;
                
                $('#volumeControl').style.display = 'inline-block';
                $('#inputVolume').addEventListener('change', e => {
                    this.adjustGain();
                });

                iomgr.onCommand('beep', data => this.sound(data));
            }
            createAudioContext () {
                this.context = new this.audioContext();
                this.context.createOscillator();
            }
            sound(value) {
                this.noteOff();
                if (value > 0) {
                    this.noteOn(value);
                }
            }
            noteOn(freq) {
                // this.noteOff();
                
                this.gain = this.context.createGain();
                this.adjustGain();
                
                this.src = this.context.createOscillator();
                this.src.type = 'square';
                this.src.frequency.value = freq;
                this.src.connect(this.gain);
                this.gain.connect(this.context.destination);
                this.src.start(0);
            }
            noteOff() {
                if (this.src) {
                    this.src.disconnect();
                }
                this.src = null;
                this.gain = null;
            }
            getGain() {
                const val = $('#inputVolume').value;
                return val * val / 200;
            }
            adjustGain() {
                if (this.gain) {
                    this.gain.gain.value = this.getGain();
                }
            }
        }

        // Virtual MIDI Device
        const PORT_NOT_SELECTED = -1;
        class VirtualMidiDevice {
            constructor (iomgr, div) {
                if (!navigator.requestMIDIAccess) return;

                (function() {
                    return new Promise(async (resolve, reject) => {
                        let midi;
                        try {
                            midi = await navigator.requestMIDIAccess({sysex: true});
                        } catch(e) { };
                        if (!midi) {
                            midi = await navigator.requestMIDIAccess({sysex: false});
                        }
                        if (midi) resolve(midi);
                        else reject();
                    });
                })().then((midi) => {
                    // this.midi = midi;

                    this.selectedIndex = PORT_NOT_SELECTED;

                    this.outputs = [];
                    if (typeof midi.outputs === 'function') {
                        const ot = midi.outputs();
                        for(let i = 0; i < ot.length ; i++){
                            this.outputs.push(ot[i]);
                        }
                    } else {
                        const ot = midi.outputs.values();
                        for(let o = ot.next(); !o.done; o = ot.next()){
                            this.outputs.push(o.value);
                        }
                    }
                    if (this.outputs.length == 0) return;

                    div.setAttribute('class', 'controlFrame');
                    const label = document.createElement('label');
                    label.appendChild(document.createTextNode(`\uD83C\uDFB9 MIDI Out: `));
                    const select = document.createElement('select');
                    select.setAttribute('id', 'midiSelector');
                    {
                        const option = document.createElement('option');
                        option.setAttribute('value', PORT_NOT_SELECTED);
                        option.appendChild(document.createTextNode('---'));
                        select.appendChild(option);
                    }
                    for(let i = 0; i < this.outputs.length; i++){
                        const output = this.outputs[i];
                        console.log('midi_out', { type: output.type, id: output.id, manufacturer: output.manufacturer, name: output.name, version: output.version });
                        let option = document.createElement('option');
                        option.setAttribute('value', i);
                        option.appendChild(document.createTextNode(output.name));
                        select.appendChild(option);
                    }
                    label.appendChild(select);
                    select.addEventListener('change', e => {
                        this.selectedIndex = $('#midiSelector').value;
                        $('#midiMode').innerText = '';
                    });
                    div.appendChild(label);

                    div.appendChild(document.createTextNode(' '));
                    const button1 = document.createElement('a');
                    button1.setAttribute('class', 'buttonFace');
                    button1.setAttribute('id', 'midiTest');
                    button1.appendChild(document.createTextNode('Test'));
                    div.appendChild(button1);
                    button1.addEventListener('click', e => {
                        this.midiTest();
                    });

                    div.appendChild(document.createTextNode(' '));
                    const button2 = document.createElement('a');
                    button2.setAttribute('class', 'buttonFace destructiveButton');
                    button2.setAttribute('id', 'midiPanic');
                    button2.appendChild(document.createTextNode('Panic'));
                    div.appendChild(button2);
                    button2.addEventListener('click', e => {
                        this.midiPanic();
                    });

                    div.appendChild(document.createTextNode(' '));
                    const span = document.createElement('span');
                    span.setAttribute('id', 'midiMode');
                    div.appendChild(span);

                    iomgr.onCommand('midi', data => this.midiOut(data));
                    iomgr.onConnect('midi', true);
                })
                .catch(reason => console.error(reason));
            }
            midiOut (messages) {
                try {
                    if (this.selectedIndex != PORT_NOT_SELECTED){
                        if (messages[0] == 0xF0) {
                            setTimeout(this.parseSysEx(messages), 1);
                        }
                        this.outputs[this.selectedIndex].send(messages);
                    }
                } catch (e) {
                    console.error('midi_out', e);
                }
            }
            parseSysEx(sysex) {
                if (!(sysex.length > 0) || (sysex[0] != 0xF0)) throw new Error(`SysEx: Parse Error: ${sysex}`);
                if (sysex.length >= 6
                && sysex[1] == 0x7E && sysex[2] == 0x7F && sysex[3] == 0x09) {
                    switch (sysex[4]) {
                    case 0x01: // F0 7E 7F 09 01 F7 GM System ON
                        console.log('midi_sysex', 'GM System ON');
                        $('#midiMode').innerText = 'GM';
                        break;
                    case 0x02: // F0 7E 7F 09 02 F7 GM System OFF
                        console.log('midi_sysex', 'GM System OFF');
                        $('#midiMode').innerText = '';
                        break;
                    case 0x03: // F0 7E 7F 09 03 F7 GM2 System ON
                        console.log('midi_sysex', 'GM2 System ON');
                        $('#midiMode').innerText = 'GM2';
                        break;
                    }
                } else if (sysex.length >= 11
                && sysex[1] == 0x41 && sysex[3] == 0x42 && sysex[4] == 0x12) {
                    if (sysex[5] == 0x40 && sysex[6] == 0x00 && sysex[7] == 0x7F && sysex[8] == 0x00) {
                        // F0 41 10 42 12 40 00 7F 00 41 F7 GS Reset
                        console.log('midi_sysex', 'GS Reset');
                        $('#midiMode').innerText = 'GS';
                    } else if (sysex[5] == 0x00 && sysex[6] == 0x00 && sysex[7] == 0x7F && sysex[8] == 0x00) {
                        // F0,41,10,42,12,00,00,7F,00,01,F7 System Mode Set 1
                        console.log('midi_sysex', 'System Mode Set 1 (GS)');
                        $('#midiMode').innerText = 'GS';
                    }
                } else if (sysex.length >= 9 && sysex[1] == 0x43 && sysex[3] == 0x4C) {
                    if (sysex[4] == 0x00 && sysex[5] == 0x00 && sysex[6] == 0x7E && sysex[7] == 0x00) {
                        // F0,43,10,4C,00,00,7E,00,F7 XG System ON
                        console.log('midi_sysex', 'XG System ON');
                        $('#midiMode').innerText = 'XG';
                    }
                }
            }
            midiTest () {
                if (this.selectedIndex != PORT_NOT_SELECTED) {
                    const testNote = 69;
                    this.midiOut([0x90, testNote, 40 + Math.random() * 80]);
                    setTimeout(() => this.midiOut([0x90, testNote, 0]), 500);
                }
            }
            midiPanic () {
                try {
                    if (this.selectedIndex != PORT_NOT_SELECTED) {
                        this.outputs[this.selectedIndex].send([
                        0xB0, 0x78, 0, 0xB1, 0x78, 0, 0xB2, 0x78, 0, 0xB3, 0x78, 0, 
                        0xB4, 0x78, 0, 0xB5, 0x78, 0, 0xB6, 0x78, 0, 0xB7, 0x78, 0, 
                        0xB8, 0x78, 0, 0xB9, 0x78, 0, 0xBA, 0x78, 0, 0xBB, 0x78, 0,
                        0xBC, 0x78, 0, 0xBD, 0x78, 0, 0xBE, 0x78, 0, 0xBF, 0x78, 0,
                        ]);
                    }
                } catch (e) {
                    console.error('midi_out', e);
                }
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            window.beep = new i8254Sound(window.iomgr);
            window.midi = new VirtualMidiDevice(window.iomgr, $('#cpMidi'));
            $('#click_to_start').addEventListener('click', e => {
                if (!window.WebAssembly) {
                    alert("We are sorry, but WebAssembly is not supported.");
                    return;
                }
                startEmu();
            });

            $('#buttonReset').addEventListener('click', e => {
                if (window.worker) {
                    worker.postMessage({command: 'reset', gen: parseInt($('#selCpuGen').value)});
                }
            });

            $('#buttonNMI').addEventListener('click', e => {
                if (window.worker) {
                    worker.postMessage({command: 'nmi', regName: $('#selRegName').value });
                }
            });
            $('#buttonDump').addEventListener('click', e => {
                const rawValue = $('#inputAddress').value;
                let address = 0;
                if (rawValue.indexOf(':') > 0) {
                    const pair = rawValue.split(':');
                    address = (parseInt(`0x0${pair[0]}`) << 4) + (parseInt(`0x0${pair[1]}`));
                } else {
                    address = parseInt(`0x0${rawValue}`);
                }
                if (window.worker) {
                    worker.postMessage({command: 'dump', address: address})
                }
            });
            $('#selRegName').addEventListener('change', e => {
                if (window.worker) {
                    worker.postMessage({command: 'readReg', regName: $('#selRegName').value });
                }
            });

            $('#buttonLocal').addEventListener('click', e => {
                $('#fileLocal').click();
            });
            const vfdAttach = (name, blob) => {
                $('#selDiskImage').value = "";
                $('#labelLocal').value = name;
                if (window.worker) {
                    worker.postMessage({command: 'attach', blob: blob});
                } else {
                    window.attach = blob;
                }
            }
            $('#fileLocal').addEventListener('change', e => {
                const reader = new FileReader();
                reader.addEventListener('load', (e) => {
                    vfdAttach($('#fileLocal').value, e.target.result);
                });
                reader.readAsArrayBuffer(e.target.files[0]);
            });

            $('html').addEventListener('dragover', e => {
                e.stopPropagation();
                e.preventDefault();
                $('#frameFD').classList.add('controlActive');
            }, false);
            $('html').addEventListener('dragleave', e => {
                e.stopPropagation();
                e.preventDefault();
                $('#frameFD').classList.remove('controlActive');
            }, false);
            $('html').addEventListener('drop', e => {
                e.stopPropagation();
                e.preventDefault();
                $('#frameFD').classList.remove('controlActive');
                const reader = new FileReader();
                const file = e.dataTransfer.files[0]
                reader.addEventListener('load', (e) => {
                    vfdAttach(file.name, e.target.result);
                });
                reader.readAsArrayBuffer(file);
            }, false);
        });

</script>
</head>
<body>
    <div id="emulatorFrame">
        <div id="screen_container">
            <!-- <textarea id="terminal2"></textarea>
            <canvas id="canvasVGA" width="320" height="200" style="width: 640px; height: 400px;"></canvas> -->
            <div id="terminal"></div>
        </div>
        <div id="click_to_start"><p>CLICK TO START</p></div>
    </div>

    <div id="controlPanel">
        <div class="left">
            <label id="volumeControl" class="controlFrame">
                &#x1F64A;<input id="inputVolume" type="range" min="0" max="10" step="1" value="5">&#x1F649;
            </label>
            <span id="frameFD" class="controlFrame">
                <label>
                    &#x1f4be;
                    <select id="selDiskImage">
                        <option value="">----</option>
                        <option value="../bin/osz.img" selected>osz</option>
                        <option value="../bin/fdos.img">FreeDOS</option>
                    </select>
                </label>
                <label>
                    <a id="buttonLocal" class="buttonFace">file:</a>
                    <input id="labelLocal" type="text" readonly>
                </label>
                <input id="fileLocal" type="file" style="position: absolute; width:0px; height:0px;">
            </span>
        </div>
        <details open>
            <summary class="buttonFace activeButton">Option</summary>
            <article>

                <div class="controlFrame">
                    &#x1F4A1;
                    <a id="buttonReset" class="buttonFace destructiveButton">RESET</a>
                    <label>
                        CPU:
                        <select id="selCpuGen">
                            <option value="0">8086</option>
                            <option value="1">80186</option>
                            <option value="2">80286</option>
                            <option value="3">386SX</option>
                            <option value="4" selected>486SX</option>
                        </select>
                    </label>

                    <label>
                        Memory:
                        <select id="selMemory">
                            <option value="64">64KB</option>
                            <option value="128">128KB</option>
                            <option value="256">256KB</option>
                            <option value="384">384KB</option>
                            <option value="512">512KB</option>
                            <option value="640" selected>640KB</option>
                            <option value="768">768KB *</option>
                            <option value="896">896KB *</option>
                            <option value="960">960KB *</option>
                            <option value="2048">2MB</option>
                            <option value="3072">3MB</option>
                            <option value="4096">4MB</option>
                            <option value="6144">6MB</option>
                            <option value="8192">8MB</option>
                            <option value="10240">10MB</option>
                            <option value="12288">12MB</option>
                            <option value="16384">16MB</option>
                            <!-- <option value="24576">24MB</option>
                            <option value="32768">32MB</option>
                            <option value="65536">64MB</option> -->
                        </select>
                    </label>
                </div>

                <div id="cpMidi"></div>

                <div class="controlFrame">
                    &#x1F41B;
                    <a id="buttonNMI" class="buttonFace">Step</a>
                    <select id="selRegName">
                        <option value="AX">AX</option>
                        <option value="BX">BX</option>
                        <option value="CX">CX</option>
                        <option value="DX">DX</option>
                        <option value="BP">BP</option>
                        <option value="SP">SP</option>
                        <option value="SI">SI</option>
                        <option value="DI">DI</option>
                        <option value="IP">IP</option>
                        <option value="flags">flags</option>
                        <option value="CS">CS</option>
                        <option value="DS">DS</option>
                        <option value="ES">ES</option>
                        <option value="SS">SS</option>
                        <option value="FS">FS</option>
                        <option value="GS">GS</option>
                        <option value="CR0">CR0</option>
                    </select>
                    <input id="inputRegister" value="" placeholder="00000000" size="12">
                    <a id="buttonRegR" class="buttonFace">Read</a>
                    <a id="buttonRegW" class="buttonFace">Write</a>
                    <input id="inputAddress" value="" placeholder="0000:0000" size="12">
                    <a id="buttonDump" class="buttonFace">Dump</a>
                </div>
            </article>
        </details>
    </div>

    <address>
        POWERED by 
        <a href="https://github.com/neri/vpc">Virtual Playground</a>
        <!-- / <a href="https://github.com/xtermjs/xterm.js/">xterm.js</a> -->
    </address>
</body>
</html>
