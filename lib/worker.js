!function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,s){function o(t){try{u(i.next(t))}catch(t){s(t)}}function a(t){try{u(i.throw(t))}catch(t){s(t)}}function u(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(o,a)}u((i=i.apply(t,e||[])).next())})},r=this&&this.__generator||function(t,e){var n,i,r,s,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=(r=o.trys).length>0&&r[r.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};e.__esModule=!0;var s=n(1),o=n(4),a=n(5),u=n(6),h=n(7),c=self,f=new(function(){function t(){}return t.prototype.print=function(t){this.postCommand("write",t)},t.prototype.postCommand=function(t,e){c.postMessage({command:t,data:e})},t.prototype.hasClass=function(t){return"function"==typeof c[t]},t}()),p=new s.RuntimeEnvironment(f),d=new o.PS2(p),l=new u.VFD(p);new a.VGA(p);self.env=p,self.ps2=d,function(){i(this,void 0,void 0,function(){return r(this,function(t){switch(t.label){case 0:return console.log("Loading CPU..."),[4,fetch("./vcpu.wasm").then(function(t){if(!t.ok)throw Error(t.statusText);return t.arrayBuffer()}).then(function(t){return WebAssembly.instantiate(t,p)}).then(function(t){return p.loadCPU(t.instance)})];case 1:return t.sent(),console.log("Loading BIOS..."),[4,fetch("./bios.bin").then(function(t){if(!t.ok)throw Error(t.statusText);return t.blob()}).then(function(t){return new Promise(function(e){var n=new FileReader;n.onloadend=function(){e(n.result)},n.readAsArrayBuffer(t)})}).then(function(t){var e=new Uint8Array(t);p.fetchBIOS(e)})];case 2:return t.sent(),f.postCommand("loaded",null),[2]}})})}(),onmessage=function(t){switch(t.data.command){case"start":p.initMemory(t.data.mem),p.iomgr.ioRedirectMap=t.data.ioRedirectMap,t.data.midi&&new h.MPU401(p,816),setTimeout(function(){return p.run(t.data.gen)},100);break;case"reset":p.reset(t.data.gen);break;case"key":d.onKey(t.data.data);break;case"nmi":p.nmi();break;case"dump":f.postCommand("devWrite",p.dump(t.data.address));break;case"attach":try{l.attachImage(t.data.blob)}catch(t){f.postCommand("alert",t.toString())}break;default:console.log("worker.onmessage",t.data)}}},function(t,e,n){"use strict";e.__esModule=!0;var i=n(2),r=n(3),s=function(){function t(t){var e=this;this.worker=t,this.period=0,this.lastTick=(new Date).valueOf(),this.env={memoryBase:0,memory:new WebAssembly.Memory({initial:1,maximum:1030})},this._memory=new Uint8Array(this.env.memory.buffer),this.env.println=function(n){var i=e.getCString(n);t.print(i)},this.env.vpc_outb=function(t,n){return e.iomgr.outb(t,n)},this.env.vpc_inb=function(t){return e.iomgr.inb(t)},this.env.vpc_outw=function(t,n){return e.iomgr.outw(t,n)},this.env.vpc_inw=function(t){return e.iomgr.inw(t)},this.env.vpc_outd=function(t,n){return e.iomgr.outd(t,n)},this.env.vpc_ind=function(t){return e.iomgr.ind(t)},this.env.vpc_irq=function(){return e.pic.dequeueIRQ()},this.env.TRAP_NORETURN=function(){throw new Error("UNEXPECTED CONTROL FLOW")},this.env.vpc_grow=function(t){var n=e.env.memory.grow(t);return e._memory=new Uint8Array(e.env.memory.buffer),n},this.iomgr=new i.IOManager(t),this.pic=new r.VPIC(this.iomgr),this.pit=new r.VPIT(this),this.rtc=new r.RTC(this),this.uart=new r.UART(this,1016,4),this.iomgr.onw(0,void 0,function(t){return 65535*Math.random()}),this.iomgr.on(3321,function(t,n){return e.reset(-1)}),this.iomgr.onw(64512,void 0,function(t){return e.memoryConfig[0]}),this.iomgr.onw(64514,void 0,function(t){return e.memoryConfig[1]})}return t.prototype.loadCPU=function(t){this.instance=t},t.prototype.fetchBIOS=function(t){this.bios=t},t.prototype.initMemory=function(t){console.log("Memory: "+t+"KB OK"),this.memoryConfig=t<1024?new Uint16Array([t,0]):new Uint16Array([640,t-1024]),this.vmem=this.instance.exports._init((t+1023)/1024),this.loadBIOS()},t.prototype.loadBIOS=function(){var t=(this.bios[0]|this.bios[1]<<8)<<4;this.dmaWrite(t,this.bios)},t.prototype.setTimer=function(t){this.period=t},t.prototype.setSound=function(t){this.worker.postCommand("beep",t)},t.prototype.emit=function(t,e){for(var n=e.length,i=this.vmem+t,r=0;r<n;r++){var s=e[r];if("string"==typeof s)for(var o=0;o<s.length;o++)this._memory[i]=s.charCodeAt(o),i++;else{if("number"!=typeof s)throw"Unexpected type "+typeof s;this._memory[i]=s,i++}}},t.prototype.dmaWrite=function(t,e){var n=new Uint8Array(e);this._memory.set(n,this.vmem+t)},t.prototype.dmaRead=function(t,e){var n=this.vmem+t;return this._memory.slice(n,n+e)},t.prototype.strlen=function(t){for(var e=0,n=t;this._memory[n];n++)e++;return e},t.prototype.getCString=function(t){var e=this.strlen(t),n=new Uint8Array(this._memory.buffer,t,e);return this.worker.hasClass("TextDecoder")?new TextDecoder("utf-8").decode(n):String.fromCharCode.apply(String,n)},t.prototype.reset=function(t){this.instance&&(console.log("CPU restarted ("+t+")"),this.loadBIOS(),this.instance.exports.reset(this.cpu,t),this.isPausing=!1,this.isRunning&&!this.isDebugging||(this.isDebugging=!1,this.isRunning=!0,this.cont()))},t.prototype.run=function(t){this.cpu=this.instance.exports.alloc_cpu(t),this.regmap=JSON.parse(this.getCString(this.instance.exports.debug_get_register_map(this.cpu))),console.log("CPU started ("+t+")"),this.isRunning=!0,this.cont()},t.prototype.cont=function(){var t,e=this;if(this.period>0)for(var n=(new Date).valueOf(),i=this.lastTick+this.period;n>=i;i+=this.period)this.pic.raiseIRQ(0),this.lastTick=i;try{t=this.instance.exports.run(this.cpu)}catch(e){console.error(e),t=65536,this.instance.exports.debug_dump(this.cpu)}if(this.dequeueUART(),t>=65536)this.isRunning=!1,console.log("CPU enters to shutdown ("+t.toString(16)+")");else if(this.isDebugging)this.instance.exports.debug_dump(this.cpu),this.isPausing=!0;else{var r=1;switch(t){case 4096:n=(new Date).valueOf();(r=(i=this.lastTick+this.period)-n)<0&&(r=0);break;case 1:var s=this.getReg("CR0"),o=[];2147483648&s&&o.push("Paged"),1&s?o.push("Protected Mode"):o.push("Real Mode"),console.log("CPU Mode Change: "+("00000000"+s.toString(16)).slice(-8)+" "+o.join(" "))}setTimeout(function(){return e.cont()},r)}},t.prototype.dequeueUART=function(){var t=this.uart.dequeueTX();t.length>0&&this.worker.print(String.fromCharCode.apply(String,t))},t.prototype.nmi=function(){!this.isRunning||this.isPausing?(this.instance.exports.step(this.cpu),this.instance.exports.debug_dump(this.cpu)):this.isDebugging=!0,this.dequeueUART()},t.prototype.setReg=function(t,e){var n=this.regmap[t];if(!n)throw new Error("Unexpected Regsiter Name: "+t);new Uint32Array(this.env.memory.buffer,n,1)[0]=e},t.prototype.getReg=function(t){var e=this.regmap[t];if(!e)throw new Error("Unexpected Regsiter Name: "+t);return new Uint32Array(this.env.memory.buffer,e,1)[0]},t.prototype.dump=function(t){for(var e,n=function(t){return("00"+t.toString(16)).substr(-2)},i=[],r=0;r<16;r++){for(var s=t+16*r,o=[(e=s,("00000000"+e.toString(16)).substr(-8))],a=[],u=0;u<16;u++){var h=this._memory[this.vmem+s+u];o.push(n(h)),h>=32&&h<127?a.push(String.fromCharCode(h)):a.push(".")}o.push(a.join("")),i.push(o.join(" "))}return i.join("\n")},t.prototype.get_vram_signature=function(t,e){return this.instance.exports.get_vram_signature(t,e)},t}();e.RuntimeEnvironment=s},function(t,e,n){"use strict";e.__esModule=!0;var i=function(){function t(t){this.worker=t,this.obHandlers=[],this.ibHandlers=[],this.owHandlers=[],this.iwHandlers=[],this.odHandlers=[],this.idHandlers=[],this.ioRedirectMap=new Uint32Array(2048)}return t.prototype.on=function(t,e,n){null!=e&&(this.obHandlers[65535&t]=e),null!=n&&(this.ibHandlers[65535&t]=n)},t.prototype.onw=function(t,e,n){null!=e&&(this.owHandlers[65535&t]=e),null!=n&&(this.iwHandlers[65535&t]=n)},t.prototype.ond=function(t,e,n){null!=e&&(this.odHandlers[65535&t]=e),null!=n&&(this.idHandlers[65535&t]=n)},t.prototype.isRedirectRequired=function(t){return 0!=(this.ioRedirectMap[t>>5]&1<<(31&t))},t.prototype.outb=function(t,e){var n=this.obHandlers[65535&t];n&&n(t,255&e),this.isRedirectRequired(t)&&this.worker.postCommand("outb",{port:t,data:e})},t.prototype.outw=function(t,e){var n=this.owHandlers[65535&t];n?n(t,65535&e):t<1024&&(this.outb(t,255&e),this.outb(t+1,e>>8))},t.prototype.outd=function(t,e){var n=this.odHandlers[65535&t];n&&n(t,0|e)},t.prototype.inb=function(t){var e=this.ibHandlers[65535&t];return e?255&e(t):255},t.prototype.inw=function(t){var e=this.iwHandlers[65535&t];return e?65535&e(t):65535},t.prototype.ind=function(t){var e=this.idHandlers[65535&t];return e?0|e(t):-1},t}();e.IOManager=i},function(t,e,n){"use strict";e.__esModule=!0;var i=4,r=function(){function t(t){var e=this;this.irq=[],this.phase=[0,0],this.IMR=new Uint8Array([255,255]),this.ISR=new Uint8Array(2),this.ICW=new Uint8Array(2*i),this.intCount=[];for(var n=0;n<16;n++)this.intCount[n]=0;t.on(32,function(t,n){return e.writeCMD(0,n)},function(t){return e.readCMD(0)}),t.on(33,function(t,n){return e.writeIMR(0,n)},function(t){return e.readIMR(0)}),t.on(160,function(t,n){return e.writeCMD(1,n)},function(t){return e.readCMD(1)}),t.on(161,function(t,n){return e.writeIMR(1,n)},function(t){return e.readIMR(1)})}return t.prototype.writeCMD=function(t,e){if(16&e)this.phase[t]=1,this.ICW[4*t]=e,this.ISR[t]=0;else if(32==(248&e))for(var n=0;n<8;n++){var i=1<<n;if(this.ISR[t]&i){this.ISR[t]&=~i,this.enqueue(0);break}}else if(96==(248&e)){i=1<<(7&e);this.ISR[t]&i&&(this.ISR[t]&=~i,this.enqueue(0))}},t.prototype.readCMD=function(t){return this.ISR[t]},t.prototype.writeIMR=function(t,e){var n=this.phase[t];n>0&&n<i?(this.ICW[t*i+n]=e,this.phase[t]=1+n):this.IMR[t]=e},t.prototype.readIMR=function(t){return this.IMR[t]},t.prototype.enqueue=function(t){for(var e=0;e<8;e++){if(this.phase[t]!=i)return;if(this.irq.length)return;var n=8*t+e,r=1<<e;if(0==t&&e==this.ICW[0]&&0==(this.IMR[0]&r)){this.enqueue(1);break}if(this.ISR[t]&r)break;this.IMR[t]&r||this.intCount[n]>0&&(this.intCount[n]--,this.ISR[t]|=r,this.irq.push(n))}},t.prototype.raiseIRQ=function(t){this.intCount[t]++,this.enqueue(0)},t.prototype.clearPendingIRQ=function(t){this.intCount[t]=0},t.prototype.dequeueIRQ=function(){var t=this.irq.shift();if(null!=t){var e=t>>3,n=7&t,r=1<<n;return this.ISR[e]|=r,248&this.ICW[e*i+1]|n}return 0},t}();e.VPIC=r;var s=function(){function t(t){var e=this;this.env=t,this.cntModes=new Uint8Array(3),this.cntPhases=[0,0,0],this.cntValues=new Uint8Array(6),this.p0061_data=0,t.iomgr.on(64,function(t,n){return e.outCntReg(0,n)}),t.iomgr.on(65,function(t,n){return e.outCntReg(1,n)}),t.iomgr.on(66,function(t,n){return e.outCntReg(2,n)}),t.iomgr.on(67,function(t,n){var i=n>>6&3;if(i<3&&(n>>4&3)>0)switch(e.cntModes[i]=n,e.cntPhases[i]=0,e.cntValues[2*i]=0,e.cntValues[2*i+1]=0,i){case 0:e.clearTimer();break;case 2:e.noteOff()}return!1}),t.iomgr.on(97,function(t,n){var i=e.p0061_data;return e.p0061_data=n,2&(i^n)&&(2&n?e.noteOn():e.noteOff()),!1},function(t){return e.p0061_data})}return t.prototype.outCntReg=function(t,e){if(1!=this.cntPhases[t])this.cntValues[2*t]=e,this.cntPhases[t]=1;else switch(this.cntValues[2*t+1]=e,this.cntPhases[t]=0,t){case 0:this.setTimer();break;case 2:2&this.p0061_data&&this.noteOn()}},t.prototype.noteOn=function(){var t=1193181/this.getCounter(2);this.env.setSound(t)},t.prototype.noteOff=function(){this.env.setSound(0)},t.prototype.getCounter=function(t){var e=this.cntValues[2*t]+256*this.cntValues[2*t+1];return e||(e=65536),e},t.prototype.clearTimer=function(){this.env.setTimer(0),this.env.pic.clearPendingIRQ(0)},t.prototype.setTimer=function(){this.env.setTimer(this.getCounter(0)/1193.181)},t}();e.VPIT=s;var o=function(){function t(t,e,n){var i=this;this.env=t,this.irq=n,this.fifo_o=[],this.fifo_i=[],t.iomgr.on(e,function(t,e){return i.fifo_o.push(e)},function(t){return i.fifo_i.shift()||0}),t.iomgr.on(e+1,function(t,e){return i.IER=e},function(t){return i.IER}),t.iomgr.on(e+5,void 0,function(t){return 96|(i.fifo_i.length>0?1:0)})}return t.prototype.dequeueTX=function(){var t=this.fifo_o.slice();return this.fifo_o=[],t},t.prototype.onRX=function(t){this.fifo_i.push(255&t),1&this.IER&&this.env.pic.raiseIRQ(this.irq)},t}();e.UART=o;var a=function(){function t(t){var e=this;this.ram=new Uint8Array(256),t.iomgr.on(112,function(t,n){return e.index=n},function(t){return e.index}),t.iomgr.on(113,function(t,n){return e.writeRTC(n)},function(t){return e.readRTC()})}return t.prototype.writeRTC=function(t){this.ram[this.index]=t},t.prototype.readRTC=function(){var t=function(t){return t%10+((t/10|0)<<4)},e=new Date;switch(this.index){case 0:return t(e.getSeconds());case 2:return t(e.getMinutes());case 4:return t(e.getHours());case 6:return e.getDay();case 7:return t(e.getDate());case 8:return t(1+e.getMonth());case 9:return t(e.getFullYear()%100);case 50:return t(e.getFullYear()/100|0);default:return this.ram[this.index]}},t}();e.RTC=a},function(t,e,n){"use strict";e.__esModule=!0;var i={AltLeft:56,AltRight:57400,ControlLeft:29,ControlRight:57373,ShiftLeft:42,ShiftRight:54,KeyA:30,KeyB:48,KeyC:46,KeyD:32,KeyE:18,KeyF:33,KeyG:34,KeyH:35,KeyI:23,KeyJ:36,KeyK:37,KeyL:38,KeyM:50,KeyN:49,KeyO:24,KeyP:25,KeyQ:16,KeyR:19,KeyS:31,KeyT:20,KeyU:22,KeyV:47,KeyW:17,KeyX:45,KeyY:21,KeyZ:44},r=[0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,0,0,0,0,0,0,0,1,0,0,0,0,57,0,0,0,0,75,72,77,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,0,0,0,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,111,0,0,0,0,0,111,111,111,111,111,111,111,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,111,111,111,111,0,0,0,111,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=function(){function t(t){var e=this;this.env=t,this.iram=new Uint8Array(32),this.o_fifo=[],this.i_fifo=[],t.iomgr.on(96,function(t,e){},function(t){return e.o_fifo.shift()||0}),t.iomgr.on(100,function(t,n){return e.command(n)},function(t){return 0|(e.o_fifo.length>0?1:0)|(e.i_fifo.length>0?2:0)}),t.iomgr.onw(100,void 0,function(t){return e.o_fifo.shift()||0})}return t.prototype.command=function(t){this.lastCmd=t},t.prototype.onKey=function(t){var e=t.type,n=t.key,s=t.code,o=t.keyCode,a=t.ctrlKey,u=t.altKey,h=0,c=i[s];c||(c=r[o]),c>256&&(h=c>>8,c&=127);var f=1==n.length?n.charCodeAt(0):0;if(a&&f>=64&&f<=128&&(f&=31),f)c|=f<<8;else switch(o){case 8:case 9:case 13:case 27:c|=o<<8}switch(u&&(c&=127),0==c&&0!=f&&(c=111),e){case"keydown":break;case"keyup":c|=128}127&c&&(h&&(this.o_fifo.push(h),this.env.pic.raiseIRQ(1)),this.o_fifo.push(c),this.env.pic.raiseIRQ(1))},t}();e.PS2=s},function(t,e,n){"use strict";e.__esModule=!0;var i=45249,r=0,s=1,o=2,a=3,u=4,h=5,c=6,f=7,p=8,d=9,l=function(){function t(t){var e=this;this.env=t,this.pal_u32=new Uint32Array(256),this.pal_u8=new Uint8Array(this.pal_u32.buffer);for(var n=0;n<256;n++)this.pal_u32[n]=4278190080;this.crtcData=new Uint8Array(24),this.attrData=new Uint8Array(32),this.bgaData=new Uint16Array(10),this.bgaData[0]=i,this._vtrace=0,t.iomgr.on(948,function(t,n){return e.crtcIndex=n},function(t){return e.crtcIndex}),t.iomgr.on(949,function(t,n){return e.crtcDataWrite(e.crtcIndex,n)},function(t){return e.crtcData[e.crtcIndex]}),t.iomgr.on(980,function(t,n){return e.crtcIndex=n},function(t){return e.crtcIndex}),t.iomgr.on(981,function(t,n){return e.crtcDataWrite(e.crtcIndex,n)},function(t){return e.crtcData[e.crtcIndex]}),t.iomgr.on(954,void 0,function(t){return e.vtrace()}),t.iomgr.on(986,void 0,function(t){return e.vtrace()}),t.iomgr.on(960,function(t,n){return e.attrIndex=n},function(t){return e.attrIndex}),t.iomgr.on(961,function(t,n){switch(e.attrIndex){case 16:e.attrData[e.attrIndex]=e.setAttrMode(n);break;default:e.attrData[e.attrIndex]=n}},function(t){return e.attrData[e.attrIndex]}),t.iomgr.on(967,function(t,n){e.pal_read_index=4*n}),t.iomgr.on(968,function(t,n){e.pal_index=4*n}),t.iomgr.on(969,function(t,n){var i=e.pal_index;if(e.pal_u8[i]=(63&n)<<2|(48&n)>>4,3==(3&++i)){var r=i>>2;e.env.worker.postCommand("pal",[r,e.pal_u32[r]]),i++}e.pal_index=1023&i},function(t){var n=e.pal_read_index,i=e.pal_u8[n]>>2;return 3==(3&++n)&&n++,e.pal_read_index=1023&n,i}),t.iomgr.onw(462,function(t,n){return e.bgaIndex=n},function(t){return e.bgaIndex}),t.iomgr.onw(463,function(t,n){switch(e.bgaIndex){case r:break;case s:case o:case a:case c:case f:e.bgaData[e.bgaIndex]=n;break;case u:e.bgaData[e.bgaIndex]=e.bgaSetEnabled(n)}},function(t){switch(e.bgaIndex){case r:case s:case o:case a:case u:case h:case c:case f:case p:case d:return e.bgaData[e.bgaIndex];default:return 65535}})}return t.prototype.vtrace=function(){return this._vtrace^=8,this._vtrace},t.prototype.crtcDataWrite=function(t,e){this.crtcData[this.crtcIndex]=e},t.prototype.packedMode=function(t,e,n){return 4095&t|(4095&e)<<12|n<<24},t.prototype.setAttrMode=function(t){return 64&t?(this.vram_base=655360,this.vram_size=64e3,this.setMode([320,200],[640,400],8,1)):1&t||(this.vram_base=753664,this.vram_size=4e3,this.setMode([640,400],[640,400],4,0)),t},t.prototype.bgaSetEnabled=function(t){if(1==t){this.clearTimer();var e=this.bgaData[s],n=this.bgaData[o],i=this.bgaData[c],r=this.bgaData[f],u=this.bgaData[a],h=!1;switch(this.packedMode(e,n,u)){case this.packedMode(320,200,8):this.vram_base=655360,this.vram_size=64e3,h=!0;break;case this.packedMode(640,400,8):this.vram_base=655360,this.vram_size=65536,h=!0}return h?(this.setMode([e,n],[r,i],u,1),1):0}return this.clearTimer(),this.vram_sign=NaN,0},t.prototype.updateCursor=function(){var t=65535;0==(32&this.crtcData[10])&&(t=this.crtcData[14]<<8|this.crtcData[15]),this.env.worker.postCommand("vga_cursor",t)},t.prototype.setMode=function(t,e,n,i){var r=this;this.clearTimer(),this.env.worker.postCommand("vga_mode",{dim:t,vdim:e,bpp:n,mode:i}),this.timer=setInterval(function(){return r.transferVGA()},100)},t.prototype.clearTimer=function(){this.timer&&(clearInterval(this.timer),this.timer=null)},t.prototype.transferVGA=function(){this.updateCursor();var t=this.env.get_vram_signature(this.vram_base,this.vram_size);if(this.vram_sign!=t){this.vram_sign=t;var e=this.env.dmaRead(this.vram_base,this.vram_size);this.env.worker.postCommand("vga",e)}},t}();e.VGA=l},function(t,e,n){"use strict";e.__esModule=!0;var i=function(){function t(t){var e=this;this.env=t,this.bytesPerSector=512,this.n_heads=2,this.PTR=new Uint16Array(2),t.iomgr.onw(64768,function(t,n){switch(n){case 0:e.status=0,e.CNT=e.driveType,e.CYL=e.n_cylinders-1,e.HEAD=e.n_heads-1,e.SEC=e.n_sectors;break;case 1:e.status=e.readSectors();break;case 2:e.status=e.writeSectors()}},function(t){return e.status}),t.iomgr.onw(64770,function(t,n){return e.PTR[0]=n},function(t){return e.PTR[0]}),t.iomgr.onw(64772,function(t,n){return e.PTR[1]=n},function(t){return e.PTR[1]}),t.iomgr.on(64774,function(t,n){return e.CNT=n},function(t){return e.CNT}),t.iomgr.on(64775,function(t,n){return e.HEAD=n},function(t){return e.HEAD}),t.iomgr.on(64776,function(t,n){return e.SEC=n},function(t){return e.SEC}),t.iomgr.on(64777,function(t,n){return e.CYL=n},function(t){return e.CYL})}return t.prototype.readSectors=function(){if(0==this.maxLBA)return 128;if(6==this.status)return 6;if(!this.image||this.SEC<1||this.SEC>this.n_sectors||this.HEAD>=this.n_heads||this.CYL>=this.n_cylinders)return console.log("vfd_read: BAD SECTOR [C:"+this.CYL+" H:"+this.HEAD+" R:"+this.SEC+"]"),4;for(var t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16),n=this.CNT;n>0;n--,t++){if(t>=this.maxLBA)return 4;var i=new Uint8Array(this.image.buffer,t*this.bytesPerSector,this.bytesPerSector);this.env.dmaWrite(e,i),e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=n}return this.CNT=n,0},t.prototype.writeSectors=function(){if(0==this.maxLBA)return 128;if(6==this.status)return 6;if(!this.image||this.SEC<1||this.SEC>this.n_sectors||this.HEAD>=this.n_heads||this.CYL>=this.n_cylinders)return console.log("vfd_write: BAD SECTOR [C:"+this.CYL+" H:"+this.HEAD+" R:"+this.SEC+"]"),4;for(var t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16),n=this.CNT;n>0;n--,t++){if(t>=this.maxLBA)return 4;for(var i=this.env.dmaRead(e,this.bytesPerSector),r=t*this.bytesPerSector,s=0;s<this.bytesPerSector;s++)this.image[r+s]=i[s];e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=n}return this.CNT=n,0},t.prototype.attachImage=function(t){if(null!=t){var e=t.byteLength/1024,n=new Uint8Array(t);if(512==t.byteLength)this.image=n,this.maxLBA=1,this.driveType=4,this.n_heads=2,this.n_sectors=18,this.n_cylinders=80,console.log("vfd_attach: BootSector Only");else if(41==n[38]&&(235==n[0]||233==n[0])&&n[1]>=60&&0==n[11]&&2==n[16]&&85==n[510]&&170==n[511]){var i=n[19]+(n[20]<<8),r=0;switch(e){case 360:r=1;break;case 120:r=2;break;case 720:r=3;break;case 1440:r=4;break;case 2880:r=6}this.image=n,this.maxLBA=i,this.driveType=r,this.n_heads=n[26],this.n_sectors=n[24],this.n_cylinders=i/this.n_sectors/this.n_heads,console.log("vfd_attach: FAT "+e+"KB LBA:"+this.maxLBA+" [C:"+this.n_cylinders+" H:"+this.n_heads+" R:"+this.n_sectors+"]")}else{var s=2,o=null;r=0;switch(e){case 160:s=1,o=8;break;case 180:s=1,o=9;break;case 320:o=8;break;case 360:r=1,o=9;break;case 640:o=8;break;case 720:r=3,o=9;break;case 1200:r=2,o=15;break;case 1440:r=4,o=18;break;case 2880:r=6,o=36}if(null!=o)this.image=n,this.maxLBA=this.image.byteLength/this.bytesPerSector,this.driveType=r,this.n_heads=s,this.n_sectors=o,this.n_cylinders=this.maxLBA/this.n_heads/this.n_sectors,console.log("vfd_attach: "+e+"KB LBA:"+this.maxLBA+" [C:"+this.n_cylinders+" H:"+this.n_heads+" R:"+this.n_sectors+"]");else{if(!(e<=2880&&85==n[510]&&170==n[511]))throw new Error("Unexpected disk image format");this.image=n,this.maxLBA=Math.ceil(this.image.byteLength/this.bytesPerSector),this.driveType=4,this.n_heads=2,this.n_sectors=18,this.n_cylinders=80,console.log("vfd_attach: UNKNOWN "+e+"KB LBA:"+this.maxLBA)}}}else this.maxLBA=0,this.driveType=4,this.n_heads=2,this.n_sectors=18,this.n_cylinders=80,console.log("vfd_attach: EMPTY");this.status=6},t}();e.VFD=i},function(t,e,n){"use strict";e.__esModule=!0;var i=function(){function t(t,e){var n=this;this.env=t,this.outputBuffer=[],this.inputBuffer=[],t.iomgr.on(e,function(t,e){return n.uartOut(e)},function(t){return n.inputBuffer.shift()||0}),t.iomgr.on(e+1,function(t,e){switch(e){case 255:n.lastStatus=null,n.outputBuffer=[],n.inputBuffer=[254];break;case 63:console.log("mpu401: enter to uart mode")}},function(t){return n.inputBuffer.length>0?0:128})}return t.prototype.uartOut=function(t){if(0!=(128&t))t<240?(this.lastStatus=t,this.outputBuffer=[t]):t>=248?this.midiOut([t]):247==t?(this.outputBuffer.length>=5&&240==this.outputBuffer[0]&&(this.outputBuffer.push(t),this.midiOut(this.outputBuffer)),this.outputBuffer=[]):(this.lastStatus=null,this.outputBuffer=[t]);else{if(0==this.outputBuffer.length){if(null==this.lastStatus)return;this.outputBuffer.push(this.lastStatus)}switch(this.outputBuffer.push(t),240&this.outputBuffer[0]){case 240:break;case 192:case 208:2==this.outputBuffer.length&&(this.midiOut(this.outputBuffer),this.outputBuffer=[]);break;default:3==this.outputBuffer.length&&(this.midiOut(this.outputBuffer),this.outputBuffer=[])}}},t.prototype.midiOut=function(t){this.env.worker.postCommand("midi",t)},t}();e.MPU401=i}]);