!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){this.worker=t,this.obHandlers=[],this.owHandlers=[],this.ibHandlers=[],this.iwHandlers=[],this.ioRedirectMap=new Uint32Array(2048)}on(t,e,s=null){this.obHandlers[65535&t]=e,this.ibHandlers[65535&t]=s}onw(t,e,s=null){this.owHandlers[65535&t]=e,this.iwHandlers[65535&t]=s}isRedirectRequired(t){return 0!=(this.ioRedirectMap[t>>5]&1<<(31&t))}outb(t,e){try{const s=this.obHandlers[65535&t];s&&s(t,255&e)}catch(t){console.error("worker_outb()",t)}this.isRedirectRequired(t)&&this.worker.postCommand("outb",{port:t,data:e})}outw(t,e){try{const s=this.owHandlers[65535&t];s&&s(t,65535&e)}catch(t){console.error("worker_outw()",t)}}inb(t){const e=this.ibHandlers[65535&t];return e?255&e(t):255}inw(t){const e=this.iwHandlers[65535&t];return e?65535&e(t):65535}}class r{constructor(t){this.irq=[],this.phase=[0,0],this.IMR=new Uint8Array([255,255]),this.IRR=new Uint8Array(2),this.ISR=new Uint8Array(2),this.ICW=new Uint8Array(8),t.on(32,(t,e)=>this.writeOCR(0,e),t=>this.readOCR(0)),t.on(33,(t,e)=>this.writeIMR(0,e),t=>this.readIMR(0)),t.on(160,(t,e)=>this.writeOCR(1,e),t=>this.readOCR(1)),t.on(161,(t,e)=>this.writeIMR(1,e),t=>this.readIMR(1))}writeOCR(t,e){if(16&e)this.phase[t]=1,this.ICW[4*t]=e;else if(32==e)for(let e=0;e<8;e++){const s=1<<e;if(this.ISR[t]&s){this.ISR[t]&=~s,this.enqueue(0);break}}}readOCR(t){return this.ISR[t]}writeIMR(t,e){const s=this.phase[t]||0;s>0&&s<4?(this.ICW[4*t+s]=e,this.phase[t]=s<4?1+s:0):this.IMR[t]=e}readIMR(t){return this.IMR[t]}enqueue(t){for(let e=0;e<8;e++){if(this.irq.length)return;const s=1<<e;if(0==t&&e==this.ICW[0]&&0==(this.IMR[0]&s)){this.enqueue(1);break}if(this.ISR[t]&s)break;if(this.IRR[t]&s&&0==(this.IMR[t]&s)){this.IRR[t]&=~s,this.ISR[t]|=s;const i=(248&this.ICW[4*t+1])+e;this.irq.push(i)}}}raiseIRQ(t){t<8?(this.IRR[0]|=1<<t,this.enqueue(0)):t<16&&(this.ISR[1]|=1<<t-8,this.IRR[0]|=this.ICW[2],this.enqueue(0))}dequeueIRQ(){const t=this.irq.shift();return t&&console.log("INT",t),t||0}}class n{constructor(t){this.env=t,this.cntModes=new Uint8Array(3),this.cntPhases=[0,0,0],this.cntValues=new Uint8Array(6),this.p0061_data=0,t.iomgr.on(64,(t,e)=>this.outCntReg(0,e)),t.iomgr.on(65,(t,e)=>this.outCntReg(1,e)),t.iomgr.on(66,(t,e)=>this.outCntReg(2,e)),t.iomgr.on(67,(t,e)=>{const s=e>>6&3;if(s<3&&(e>>4&3)>0)switch(this.cntModes[s]=e,this.cntPhases[s]=0,this.cntValues[2*s]=0,this.cntValues[2*s+1]=0,s){case 0:this.clearTimer();break;case 2:this.noteOff()}return!1}),t.iomgr.on(97,(t,e)=>{const s=this.p0061_data;return this.p0061_data=e,2&(s^e)&&(2&e?this.noteOn():this.noteOff()),!1},t=>this.p0061_data)}outCntReg(t,e){if(1!=this.cntPhases[t])this.cntValues[2*t]=e,this.cntPhases[t]=1;else switch(this.cntValues[2*t+1]=e,this.cntPhases[t]=0,t){case 0:this.setTimer();break;case 2:2&this.p0061_data&&this.noteOn()}}noteOn(){const t=1193181/this.getCounter(2);this.env.setSound(t)}noteOff(){this.env.setSound(0)}getCounter(t){let e=this.cntValues[2*t]+256*this.cntValues[2*t+1];return e||(e=65536),e}clearTimer(){this.env.setTimer(0)}setTimer(){const t=Math.ceil(this.getCounter(0)/1193.181);this.env.setTimer(t)}}class o{constructor(t,e){this.fifo_i=[],t.iomgr.on(e,(e,s)=>{t.worker.print(String.fromCharCode(s))},t=>this.fifo_i.length>0?this.fifo_i.shift():0),t.iomgr.on(e+5,null,t=>64|(this.fifo_i.length>0?1:0))}onRX(t){this.fifo_i.push(255&t)}}class h{constructor(t){this.ram=new Uint8Array(256),t.iomgr.on(112,(t,e)=>this.writeRTC(e),t=>this.readRTC()),t.iomgr.on(113,(t,e)=>this.index=e,t=>this.index)}writeRTC(t){this.ram[this.index]=t}readRTC(){const t=this._readRTC();return console.log("read_rtc",this.index,t.toString(16)),t}_readRTC(){const t=t=>{return t%10+((t/10|0)<<4)};if(this.index>13||3114&1<<this.index)return this.ram[this.index];{const e=new Date;switch(this.index){case 0:return t(e.getSeconds());case 2:return t(e.getMinutes());case 4:return t(e.getHours());case 6:return e.getDay();case 7:return t(e.getDate());case 8:return t(e.getMonth());case 9:return t(e.getFullYear()%100);default:return 0}}}}const a=self;const c=new class{print(t){this.postCommand("write",t)}postCommand(t,e){a.postMessage({command:t,data:e})}},u=new class{constructor(t){this.worker=t,this.period=0,this.lastTick=(new Date).valueOf(),this.env={memoryBase:0,memory:new WebAssembly.Memory({initial:257})},this._memory=new Uint8Array(this.env.memory.buffer),this.env.println=e=>{const s=this.getCString(e);t.print(`${s}\n`)},this.env.vpc_outb=(t,e)=>this.iomgr.outb(t,e),this.env.vpc_inb=t=>this.iomgr.inb(t),this.env.vpc_outw=(t,e)=>this.iomgr.outw(t,e),this.env.vpc_inw=t=>this.iomgr.inw(t),this.env.vpc_irq=()=>this.pic.dequeueIRQ(),this.iomgr=new i(t),this.pic=new r(this.iomgr),this.pit=new n(this),this.rtc=new h(this),this.uart=new o(this,1016)}loadCPU(t){this.instance=t,this.vmem=t.exports._init()}setTimer(t){this.period=t}setSound(t){this.worker.postCommand("beep",t)}emit(t,e){const s=e.length;let i=this.vmem+t;for(let t=0;t<s;t++){const s=e[t];if("string"==typeof s)for(let t=0;t<s.length;t++)this._memory[i]=s.charCodeAt(t),i++;else{if("number"!=typeof s)throw`Unexpected type ${typeof s}`;this._memory[i]=s,i++}}}dmaWrite(t,e){const s=new Uint8Array(e),i=e.byteLength;let r=this.vmem+t;for(let t=0;t<i;t++,r++){const e=s[t];this._memory[r]=e}}dmaRead(t,e){const s=this.vmem+t;return this._memory.slice(s,s+e)}strlen(t){let e=0;for(let s=t;this._memory[s];s++)e++;return e}getCString(t){const e=this.strlen(t),s=new Uint8Array(this._memory.buffer,t,e);return new TextDecoder("utf-8").decode(s)}run(t){this.cpu=this.instance.exports.alloc_cpu(t),console.log(`CPU started (${t})`),this.isRunning=!0,this.cont()}cont(){this.period&&((new Date).valueOf()>this.lastTick+this.period&&this.pic.raiseIRQ(0),this.lastTick=(new Date).valueOf());const t=this.instance.exports.run(this.cpu);if(t>1)this.isRunning=!1,console.log(`CPU halted (${t})`);else if(this.isDebugging)this.instance.exports.debug_dump(this.cpu),this.isPausing=!0;else{let e;if(t>0){const t=(new Date).valueOf();(e=this.lastTick+this.period-t)<1&&(e=1)}else e=1;setTimeout(()=>this.cont(),e)}}nmi(){!this.isRunning||this.isPausing?(this.instance.exports.step(this.cpu),this.instance.exports.debug_dump(this.cpu)):this.isDebugging=!0}dump(t){const e=t=>("000000"+t.toString(16)).substr(-6),s=t=>("00"+t.toString(16)).substr(-2);let i=[];for(let r=0;r<16;r++){const n=t+16*r;let o=[e(n)],h=[];for(let t=0;t<16;t++){const e=this._memory[this.vmem+n+t];o.push(s(e)),e>=32&&e<127?h.push(String.fromCharCode(e)):h.push(".")}o.push(h.join("")),i.push(o.join(" "))}console.log(i.join("\n"))}}(c),l=new class{constructor(t){this.env=t,this.bytesPerSector=512,this.n_heads=2,this.PTR=new Uint16Array(2),t.iomgr.onw(64768,(t,e)=>{switch(e){case 0:this.status=this.maxLBA;break;case 1:this.status=this.readSectors();break;case 2:this.status=this.writeSectors()}},t=>this.status),t.iomgr.onw(64770,(t,e)=>this.PTR[0]=e,t=>this.PTR[0]),t.iomgr.onw(64772,(t,e)=>this.PTR[1]=e,t=>this.PTR[1]),t.iomgr.on(64774,(t,e)=>this.CNT=e,t=>this.CNT),t.iomgr.on(64775,(t,e)=>this.HEAD=e,t=>this.HEAD),t.iomgr.on(64776,(t,e)=>this.SEC=e,t=>this.SEC),t.iomgr.on(64777,(t,e)=>this.CYL=e,t=>this.CYL)}readSectors(){if(!this.image||this.SEC<1||this.SEC>this.n_sectors+1||this.HEAD>this.n_heads||this.CYL>this.n_cylinders)return console.log(`vfd_read: BAD SECTOR [C:${this.CYL} H:${this.HEAD} R:${this.SEC}]`),1;let t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16);console.log(`vfd_read [C:${this.CYL} H:${this.HEAD} R:${this.SEC}] LBA:${t} MEM:${e.toString(16)} CNT:${this.CNT}`);let s=this.CNT;for(;s>0;s--,t++){if(t>=this.maxLBA)return 1;const i=new Uint8Array(this.image.buffer,t*this.bytesPerSector,this.bytesPerSector);this.env.dmaWrite(e,i),e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=s}return this.CNT=s,0}writeSectors(){if(!this.image||this.SEC<1||this.SEC>this.n_sectors+1||this.HEAD>this.n_heads||this.CYL>this.n_cylinders)return console.log(`vfd_write: BAD SECTOR [C:${this.CYL} H:${this.HEAD} R:${this.SEC}]`),1;let t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16);console.log(`vfd_write [C:${this.CYL} H:${this.HEAD} R:${this.SEC}] LBA:${t} MEM:${e.toString(16)} CNT:${this.CNT}`);let s=this.CNT;for(;s>0;s--,t++){if(t>=this.maxLBA)return 1;const i=this.env.dmaRead(e,this.bytesPerSector),r=t*this.bytesPerSector;for(let t=0;t<this.bytesPerSector;t++)this.image[r+t]=i[t];e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=s}return this.CNT=s,0}attachImage(t){const e=t.byteLength/1024;let s,i=2;switch(e){case 160:i=1,s=8;break;case 180:i=1,s=9;break;case 320:s=8;break;case 360:s=9;break;case 640:s=8;break;case 720:s=9;break;case 1200:s=15;break;case 1440:s=18;break;default:throw new Error("Unexpected image size")}this.image=new Uint8Array(t),this.maxLBA=this.image.byteLength/this.bytesPerSector,this.n_heads=i,this.n_sectors=s,this.n_cylinders=this.maxLBA/this.n_heads/this.n_sectors,console.log(`vfd_attach: ${e}KB [C:${this.n_cylinders} H:${this.n_heads} R:${this.n_sectors}] LBA:${this.maxLBA}`)}}(u);!async function(){console.log("Loading CPU..."),await fetch("./vcpu.wasm").then(t=>{if(!t.ok)throw Error(t.statusText);return t.arrayBuffer()}).then(t=>WebAssembly.instantiate(t,u)).then(t=>u.loadCPU(t.instance)),console.log("Loading BIOS..."),await fetch("./bios.bin").then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise((e,s)=>{const i=new FileReader;i.onloadend=()=>{e(i.result)},i.readAsArrayBuffer(t)})).then(t=>{const e=new Uint8Array(t),s=(e[0]|e[1]<<8)<<4;u.dmaWrite(s,e)}),c.postCommand("loaded",null)}();const d=async t=>{t&&await(async t=>(console.log(`Loading image (${t})...`),fetch(t).then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise((e,s)=>{const i=new FileReader;i.onloadend=()=>{e(i.result)},i.readAsArrayBuffer(t)})).then(t=>{l.attachImage(t)}).catch(t=>console.error(t))))(t),u.run(1)};onmessage=t=>{switch(t.data.command){case"start":u.iomgr.ioRedirectMap=t.data.ioRedirectMap,setTimeout(()=>d(t.data.imageName),10);break;case"key":u.uart.onRX(t.data.data);break;case"nmi":u.nmi();break;case"dump":u.dump(t.data.address);break;default:console.log("worker.onmessage",t.data)}}}]);