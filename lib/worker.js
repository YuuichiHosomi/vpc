!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){this.worker=t,this.obHandlers=[],this.owHandlers=[],this.ibHandlers=[],this.iwHandlers=[],this.ioRedirectMap=new Uint32Array(2048)}on(t,e,s=null){e&&(this.obHandlers[65535&t]=e),s&&(this.ibHandlers[65535&t]=s)}onw(t,e,s=null){e&&(this.owHandlers[65535&t]=e),s&&(this.iwHandlers[65535&t]=s)}isRedirectRequired(t){return 0!=(this.ioRedirectMap[t>>5]&1<<(31&t))}outb(t,e){try{const s=this.obHandlers[65535&t];s&&s(t,255&e)}catch(t){console.error("worker_outb()",t)}this.isRedirectRequired(t)&&this.worker.postCommand("outb",{port:t,data:e})}outw(t,e){try{const s=this.owHandlers[65535&t];s&&s(t,65535&e)}catch(t){console.error("worker_outw()",t)}}inb(t){const e=this.ibHandlers[65535&t];return e?255&e(t):255}inw(t){const e=this.iwHandlers[65535&t];return e?65535&e(t):65535}}class r{constructor(t){this.irq=[],this.phase=[0,0],this.IMR=new Uint8Array([255,255]),this.IRR=new Uint8Array(2),this.ISR=new Uint8Array(2),this.ICW=new Uint8Array(8),t.on(32,(t,e)=>this.writeOCR(0,e),t=>this.readOCR(0)),t.on(33,(t,e)=>this.writeIMR(0,e),t=>this.readIMR(0)),t.on(160,(t,e)=>this.writeOCR(1,e),t=>this.readOCR(1)),t.on(161,(t,e)=>this.writeIMR(1,e),t=>this.readIMR(1))}writeOCR(t,e){if(16&e)this.phase[t]=1,this.ICW[4*t]=e;else if(32==e)for(let e=0;e<8;e++){const s=1<<e;if(this.ISR[t]&s){this.ISR[t]&=~s,this.enqueue(0);break}}}readOCR(t){return this.ISR[t]}writeIMR(t,e){const s=this.phase[t]||0;s>0&&s<4?(this.ICW[4*t+s]=e,this.phase[t]=s<4?1+s:0):this.IMR[t]=e}readIMR(t){return this.IMR[t]}enqueue(t){for(let e=0;e<8;e++){if(this.irq.length)return;const s=1<<e;if(0==t&&e==this.ICW[0]&&0==(this.IMR[0]&s)){this.enqueue(1);break}if(this.ISR[t]&s)break;this.IRR[t]&s&&0==(this.IMR[t]&s)&&(this.IRR[t]&=~s,this.ISR[t]|=s,this.irq.push(8*t+e))}}raiseIRQ(t){t<8?0==t?this.irq.push(0):(this.IRR[0]|=1<<t,this.enqueue(0)):t<16&&(this.ISR[1]|=1<<t-8,this.IRR[0]|=this.ICW[2],this.enqueue(0))}dequeueIRQ(){if(this.irq.length>0){const t=this.irq.shift(),e=t>>3,s=7&t,i=1<<s;return this.ISR[e]|=i,248&this.ICW[4*e+1]|s}return 0}}class n{constructor(t){this.env=t,this.cntModes=new Uint8Array(3),this.cntPhases=[0,0,0],this.cntValues=new Uint8Array(6),this.p0061_data=0,t.iomgr.on(64,(t,e)=>this.outCntReg(0,e)),t.iomgr.on(65,(t,e)=>this.outCntReg(1,e)),t.iomgr.on(66,(t,e)=>this.outCntReg(2,e)),t.iomgr.on(67,(t,e)=>{const s=e>>6&3;if(s<3&&(e>>4&3)>0)switch(this.cntModes[s]=e,this.cntPhases[s]=0,this.cntValues[2*s]=0,this.cntValues[2*s+1]=0,s){case 0:this.clearTimer();break;case 2:this.noteOff()}return!1}),t.iomgr.on(97,(t,e)=>{const s=this.p0061_data;return this.p0061_data=e,2&(s^e)&&(2&e?this.noteOn():this.noteOff()),!1},t=>this.p0061_data)}outCntReg(t,e){if(1!=this.cntPhases[t])this.cntValues[2*t]=e,this.cntPhases[t]=1;else switch(this.cntValues[2*t+1]=e,this.cntPhases[t]=0,t){case 0:this.setTimer();break;case 2:2&this.p0061_data&&this.noteOn()}}noteOn(){const t=1193181/this.getCounter(2);this.env.setSound(t)}noteOff(){this.env.setSound(0)}getCounter(t){let e=this.cntValues[2*t]+256*this.cntValues[2*t+1];return e||(e=65536),e}clearTimer(){this.env.setTimer(0)}setTimer(){this.env.setTimer(this.getCounter(0)/1193.181)}}class h{constructor(t,e,s){this.env=t,this.irq=s,this.fifo_o=[],this.fifo_i=[],t.iomgr.on(e,(t,e)=>this.fifo_o.push(e),t=>this.fifo_i.length>0?this.fifo_i.shift():0),t.iomgr.on(e+1,(t,e)=>this.IER=e,t=>this.IER),t.iomgr.on(e+5,null,t=>32|(this.fifo_i.length>0?1:0))}dequeueTX(){const t=this.fifo_o.slice();return this.fifo_o=[],t}onRX(t){this.fifo_i.push(255&t),1&this.IER&&this.env.pic.raiseIRQ(this.irq)}}class a{constructor(t){this.ram=new Uint8Array(256),t.iomgr.on(112,(t,e)=>this.index=e,t=>this.index),t.iomgr.on(113,(t,e)=>this.writeRTC(e),t=>this.readRTC())}writeRTC(t){this.ram[this.index]=t}readRTC(){const t=t=>{return t%10+((t/10|0)<<4)},e=new Date;switch(this.index){case 0:return t(e.getSeconds());case 2:return t(e.getMinutes());case 4:return t(e.getHours());case 6:return e.getDay();case 7:return t(e.getDate());case 8:return t(1+e.getMonth());case 9:return t(e.getFullYear()%100);case 50:return t(e.getFullYear()/100|0);default:return this.ram[this.index]}}}const o=125,u=1,c=655360,d=753664,m=45248,l=0,g=1,f=2,p=3,b=4,w=1;class _{constructor(t,e){this.env=t,this.outputBuffer=[],this.inputBuffer=[],t.iomgr.on(e,(t,e)=>this.uartOut(e),t=>this.inputBuffer.shift()||0),t.iomgr.on(e+1,(t,e)=>{switch(e){case 255:this.lastStatus=null,this.outputBuffer=[],this.inputBuffer=[254];break;case 63:console.log("mpu401: enter to uart mode")}},t=>this.inputBuffer.length>0?0:128)}uartOut(t){if(0!=(128&t))t<240?(this.lastStatus=t,this.outputBuffer=[t]):t>=248?this.midiOut([t]):247==t?(this.outputBuffer.length>=5&&240==this.outputBuffer[0]&&(this.outputBuffer.push(t),this.midiOut(this.outputBuffer)),this.outputBuffer=[]):(this.lastStatus=null,this.outputBuffer=[t]);else{if(0==this.outputBuffer.length){if(!this.lastStatus)return;this.outputBuffer.push(this.lastStatus)}switch(this.outputBuffer.push(t),240&this.outputBuffer[0]){case 240:break;case 192:case 208:2==this.outputBuffer.length&&(this.midiOut(this.outputBuffer),this.outputBuffer=[]);break;default:3==this.outputBuffer.length&&(this.midiOut(this.outputBuffer),this.outputBuffer=[])}}}midiOut(t){this.env.worker.postCommand("midi",t)}}const R=self;const y=new class{print(t){this.postCommand("write",t)}postCommand(t,e){R.postMessage({command:t,data:e})}hasClass(t){return"function"==typeof R[t]}},C=new class{constructor(t){this.worker=t,this.period=0,this.lastTick=(new Date).valueOf(),this.env={memoryBase:0,memory:new WebAssembly.Memory({initial:1,maximum:1030})},this._memory=new Uint8Array(this.env.memory.buffer),this.env.println=t=>{const e=this.getCString(t);console.log(e)},this.env.vpc_outb=(t,e)=>this.iomgr.outb(t,e),this.env.vpc_inb=t=>this.iomgr.inb(t),this.env.vpc_outw=(t,e)=>this.iomgr.outw(t,e),this.env.vpc_inw=t=>this.iomgr.inw(t),this.env.vpc_irq=()=>this.pic.dequeueIRQ(),this.env.TRAP_NORETURN=()=>{throw new Error("UNEXPECTED CONTROL FLOW")},this.env.vpc_grow=t=>{const e=this.env.memory.grow(t);return this._memory=new Uint8Array(this.env.memory.buffer),e},this.iomgr=new i(t),this.pic=new r(this.iomgr),this.pit=new n(this),this.rtc=new a(this),this.uart=new h(this,1016,4),this.iomgr.onw(0,null,t=>65535*Math.random()),this.iomgr.onw(64512,null,t=>this.memoryConfig[0]),this.iomgr.onw(64514,null,t=>this.memoryConfig[1])}loadCPU(t){this.instance=t}fetchBIOS(t){this.bios=t}initMemory(t){console.log(`Memory: ${t}KB OK`),this.memoryConfig=t<1024?new Uint16Array([t,0]):new Uint16Array([640,t-1024]),this.vmem=this.instance.exports._init((t+1023)/1024),this.loadBIOS()}loadBIOS(){const t=(this.bios[0]|this.bios[1]<<8)<<4;this.dmaWrite(t,this.bios)}setTimer(t){this.period=t}setSound(t){this.worker.postCommand("beep",t)}emit(t,e){const s=e.length;let i=this.vmem+t;for(let t=0;t<s;t++){const s=e[t];if("string"==typeof s)for(let t=0;t<s.length;t++)this._memory[i]=s.charCodeAt(t),i++;else{if("number"!=typeof s)throw`Unexpected type ${typeof s}`;this._memory[i]=s,i++}}}dmaWrite(t,e){const s=new Uint8Array(e);this._memory.set(s,this.vmem+t)}dmaRead(t,e){const s=this.vmem+t;return this._memory.slice(s,s+e)}strlen(t){let e=0;for(let s=t;this._memory[s];s++)e++;return e}getCString(t){const e=this.strlen(t),s=new Uint8Array(this._memory.buffer,t,e);return this.worker.hasClass("TextDecoder")?new TextDecoder("utf-8").decode(s):String.fromCharCode.call(String,s)}reset(t){this.instance&&(console.log(`CPU restarted (${t})`),this.loadBIOS(),this.instance.exports.reset(this.cpu,t),this.isPausing=!1,this.isRunning&&!this.isDebugging||(this.isDebugging=!1,this.isRunning=!0,this.cont()))}run(t){this.cpu=this.instance.exports.alloc_cpu(t),this.regmap=JSON.parse(this.getCString(this.instance.exports.debug_get_register_map(this.cpu))),console.log(`CPU started (${t})`),this.isRunning=!0,this.cont()}cont(){if(this.period>0){const t=(new Date).valueOf();for(let e=this.lastTick+this.period;t>=e;e+=this.period)this.pic.raiseIRQ(0),this.lastTick=e}const t=this.instance.exports.run(this.cpu);if(this.dequeueUART(),t>1)this.isRunning=!1,console.log(`CPU halted (${t})`);else if(this.isDebugging)this.instance.exports.debug_dump(this.cpu),this.isPausing=!0;else{let e;if(t>0){const t=(new Date).valueOf();(e=this.lastTick+this.period-t)<0&&(e=0)}else e=1;setTimeout(()=>this.cont(),e)}}dequeueUART(){const t=this.uart.dequeueTX();t.length>0&&this.worker.print(String.fromCharCode(...t))}nmi(){!this.isRunning||this.isPausing?(this.instance.exports.step(this.cpu),this.instance.exports.debug_dump(this.cpu)):this.isDebugging=!0,this.dequeueUART()}setReg(t,e){const s=this.regmap[t];if(!s)throw new Error(`Unexpected Regsiter Name: ${t}`);new Uint32Array(this.env.memory.buffer,s,1)[0]=e}getReg(t){const e=this.regmap[t];if(!e)throw new Error(`Unexpected Regsiter Name: ${t}`);return new Uint32Array(this.env.memory.buffer,e,1)[0]}dump(t){const e=t=>("000000"+t.toString(16)).substr(-6),s=t=>("00"+t.toString(16)).substr(-2);let i=[];for(let r=0;r<16;r++){const n=t+16*r;let h=[e(n)],a=[];for(let t=0;t<16;t++){const e=this._memory[this.vmem+n+t];h.push(s(e)),e>=32&&e<127?a.push(String.fromCharCode(e)):a.push(".")}h.push(a.join("")),i.push(h.join(" "))}console.log(i.join("\n"))}get_vram_signature(t,e){return this.instance.exports.get_vram_signature(t,e)}}(y),v=new class{constructor(t){this.env=t,this.bytesPerSector=512,this.n_heads=2,this.PTR=new Uint16Array(2),t.iomgr.onw(64768,(t,e)=>{switch(e){case 0:this.status=this.driveType,this.CYL=this.n_cylinders,this.HEAD=this.n_heads,this.SEC=this.n_sectors;break;case 1:this.status=this.readSectors();break;case 2:this.status=this.writeSectors()}},t=>this.status),t.iomgr.onw(64770,(t,e)=>this.PTR[0]=e,t=>this.PTR[0]),t.iomgr.onw(64772,(t,e)=>this.PTR[1]=e,t=>this.PTR[1]),t.iomgr.on(64774,(t,e)=>this.CNT=e,t=>this.CNT),t.iomgr.on(64775,(t,e)=>this.HEAD=e,t=>this.HEAD),t.iomgr.on(64776,(t,e)=>this.SEC=e,t=>this.SEC),t.iomgr.on(64777,(t,e)=>this.CYL=e,t=>this.CYL)}readSectors(){if(!this.image||this.SEC<1||this.SEC>this.n_sectors||this.HEAD>=this.n_heads||this.CYL>=this.n_cylinders)return console.log(`vfd_read: BAD SECTOR [C:${this.CYL} H:${this.HEAD} R:${this.SEC}]`),1;let t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16),s=this.CNT;for(;s>0;s--,t++){if(t>=this.maxLBA)return 1;const i=new Uint8Array(this.image.buffer,t*this.bytesPerSector,this.bytesPerSector);this.env.dmaWrite(e,i),e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=s}return this.CNT=s,0}writeSectors(){if(!this.image||this.SEC<1||this.SEC>this.n_sectors||this.HEAD>=this.n_heads||this.CYL>=this.n_cylinders)return console.log(`vfd_write: BAD SECTOR [C:${this.CYL} H:${this.HEAD} R:${this.SEC}]`),1;let t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16),s=this.CNT;for(;s>0;s--,t++){if(t>=this.maxLBA)return 1;const i=this.env.dmaRead(e,this.bytesPerSector),r=t*this.bytesPerSector;for(let t=0;t<this.bytesPerSector;t++)this.image[r+t]=i[t];e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=s}return this.CNT=s,0}attachImage(t){const e=t.byteLength/1024;let s,i=2,r=0;if(512==t.byteLength)this.image=new Uint8Array(t),this.maxLBA=1,this.driveType=4,this.n_heads=2,this.n_sectors=18,this.n_cylinders=80,console.log(`vfd_attach: BootSector ${this.bytesPerSector}`);else{switch(e){case 160:i=1,s=8;break;case 180:i=1,s=9;break;case 320:s=8;break;case 360:r=1,s=9;break;case 640:s=8;break;case 720:r=3,s=9;break;case 1200:r=2,s=15;break;case 1440:r=4,s=18;break;case 2880:r=6,s=36;break;default:throw new Error("Unexpected image size")}this.image=new Uint8Array(t),this.maxLBA=this.image.byteLength/this.bytesPerSector,this.driveType=r,this.n_heads=i,this.n_sectors=s,this.n_cylinders=this.maxLBA/this.n_heads/this.n_sectors,console.log(`vfd_attach: ${e}KB LBA:${this.maxLBA} [C:${this.n_cylinders} H:${this.n_heads} R:${this.n_sectors}]`)}}}(C);new class{constructor(t){this.env=t,this.pal_u32=new Uint32Array(256),this.pal_u8=new Uint8Array(this.pal_u32.buffer),this.attrData=new Uint8Array(32),this.bgaData=new Uint16Array(5),this.bgaData[0]=m,t.iomgr.on(960,(t,e)=>this.attrIndex=e,t=>this.attrIndex),t.iomgr.on(961,(t,e)=>{switch(this.attrIndex){case 16:this.attrData[this.attrIndex]=this.setAttrMode(e);default:this.attrData[this.attrIndex]=e}},t=>this.attrData[this.attrIndex]),t.iomgr.on(968,(t,e)=>{this.pal_index=4*e}),t.iomgr.on(969,(t,e)=>{let s=this.pal_index;if(this.pal_u8[s]=(63&e)<<2|(48&e)>>4,3==(3&++s)){const t=s>>2;this.env.worker.postCommand("pal",[t,this.pal_u32[t]]),s++}this.pal_index=1023&s}),t.iomgr.onw(462,(t,e)=>this.bgaIndex=e,t=>this.bgaIndex),t.iomgr.onw(463,(t,e)=>{switch(this.bgaIndex){case l:break;case g:case f:case p:this.bgaData[this.bgaIndex]=e;break;case b:this.bgaData[this.bgaIndex]=this.setEnabled(e)}},t=>{switch(this.bgaIndex){case l:case g:case f:case p:case b:return this.bgaData[this.bgaIndex];default:return 65535}})}packedMode(t,e,s){return 4095&t|(4095&e)<<12|s<<24}setMode(t,e,s,i){this.clearTimer(),this.env.worker.postCommand("vga_mode",[t,e,s,i]),this.timer=setInterval(()=>this.transferVGA(),o)}setAttrMode(t){return 64&t?(this.vram_base=c,this.vram_size=64e3,this.setMode(320,200,8,u)):1&t?(this.vram_base=c,this.vram_size=65536,this.setMode(640,400,4,u)):(this.vram_base=d,this.vram_size=4e3,this.setMode(640,400,4,0)),t}setEnabled(t){if(t==w){this.clearTimer();const t=this.bgaData[g],e=this.bgaData[f],s=this.bgaData[p];let i=!1;switch(this.packedMode(t,e,s)){case this.packedMode(320,200,8):this.vram_base=c,this.vram_size=64e3,i=!0;break;case this.packedMode(640,400,8):this.vram_base=c,this.vram_size=65536,i=!0}return i?(this.setMode(t,e,s,u),1):0}return this.clearTimer(),this.vram_sign=NaN,0}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}transferVGA(){const t=this.env.get_vram_signature(this.vram_base,this.vram_size);if(this.vram_sign!=t){this.vram_sign=t;const e=this.env.dmaRead(this.vram_base,this.vram_size);this.env.worker.postCommand("vga",e)}}}(C);let S;!async function(){y.print("Loading CPU...\n"),console.log("Loading CPU..."),await fetch("./vcpu.wasm").then(t=>{if(!t.ok)throw Error(t.statusText);return t.arrayBuffer()}).then(t=>WebAssembly.instantiate(t,C)).then(t=>C.loadCPU(t.instance)),y.print("Loading BIOS...\n"),console.log("Loading BIOS..."),await fetch("./bios.bin").then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise(e=>{const s=new FileReader;s.onloadend=()=>{e(s.result)},s.readAsArrayBuffer(t)})).then(t=>{const e=new Uint8Array(t);C.fetchBIOS(e)}),y.postCommand("loaded",null)}();const I=async(t,e)=>{e&&await(async t=>(y.print("Loading image...\n"),console.log(`Loading image ${t}`),fetch(t).then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise((e,s)=>{const i=new FileReader;i.onloadend=()=>{e(i.result)},i.readAsArrayBuffer(t)})).then(t=>{v.attachImage(t)}).catch(t=>console.error(t))))(e),C.run(t)},T=t=>{const e=C.getReg(t);y.postCommand("regResult",("00000000"+e.toString(16)).slice(-8))};onmessage=t=>{switch(t.data.command){case"start":C.initMemory(t.data.mem),C.iomgr.ioRedirectMap=t.data.ioRedirectMap,t.data.midi&&(S=new _(C,816)),setTimeout(()=>I(t.data.gen,t.data.imageName),10);break;case"reset":C.reset(t.data.gen);break;case"key":C.uart.onRX(t.data.data);break;case"nmi":C.nmi(),T(t.data.regName);break;case"readReg":T(t.data.regName);break;case"dump":C.dump(t.data.address);break;case"attach":try{v.attachImage(t.data.blob)}catch(t){y.postCommand("alert",t.toString())}break;default:console.log("worker.onmessage",t.data)}}}]);