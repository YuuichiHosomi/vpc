!function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const i=self;const n=new class{print(t){this.postCommand("write",t)}postCommand(t,e){i.postMessage({command:t,data:e})}},r=new class{constructor(t){this.worker=t,this.outHandlers=[],this.inHandlers=[],this.ioRedirectMap=new Uint32Array(2048)}on(t,e,s=null){this.outHandlers[65535&t]=e,this.inHandlers[65535&t]=s}isRedirectRequired(t){return 0!=(this.ioRedirectMap[t>>5]&1<<(31&t))}outb(t,e){try{const s=this.outHandlers[65535&t];s&&s(t,0|e)}catch(t){console.error("worker_outb()",t)}this.isRedirectRequired(t)&&this.worker.postCommand("outb",{port:t,data:e})}inb(t){const e=this.inHandlers[65535&t];return e?e(t):255}}(n),o=new class{constructor(t){this.irq=[],this.phase=[0,0],this.IMR=new Uint8Array([255,255]),this.IRR=new Uint8Array(2),this.ISR=new Uint8Array(2),this.ICW=new Uint8Array(8),t.on(32,(t,e)=>this.writeOCR(0,e),t=>this.readOCR(0)),t.on(33,(t,e)=>this.writeIMR(0,e),t=>this.readIMR(0)),t.on(160,(t,e)=>this.writeOCR(1,e),t=>this.readOCR(1)),t.on(161,(t,e)=>this.writeIMR(1,e),t=>this.readIMR(1))}writeOCR(t,e){if(16&e)this.phase[t]=1,this.ICW[4*t]=e;else if(32==e)for(let e=0;e<8;e++){const s=1<<e;if(this.ISR[t]&s){this.ISR[t]&=~s,this.setNextIRQ(t);break}}}readOCR(t){return 0}writeIMR(t,e){const s=this.phase[t]||0;s>0&&s<4?(this.ICW[4*t+s]=e,this.phase[t]=s<4?1+s:0):this.IMR[t]=e}readIMR(t){return this.IMR[t]}setNextIRQ(t){if(!this.irq.length)for(let e=0;e<8;e++){const s=1<<e;if(this.ISR[t]&s)break;if(this.IRR[t]&s&&0==(this.IMR[t]&s)){this.IRR[t]&=~s,this.ISR[t]|=s;const e=this.ICW[4*t+1];this.irq.push(e)}}}raiseIRQ(t){t<8?(this.IRR[0]|=1<<t,this.setNextIRQ(0)):t<16&&(this.IRR[1]|=1<<t-8,this.IRR[0]|=this.ICW[2],this.setNextIRQ(1))}checkIRQ(){return this.irq.shift()||0}}(r),h=new class{constructor(t,e,s){this.worker=s,this.iomgr=t,this.pic=e,this.period=0,this.lastTick=(new Date).valueOf(),this.env={memoryBase:0,memory:new WebAssembly.Memory({initial:257})},this._memory=new Uint8Array(this.env.memory.buffer),this.env.println=t=>{const e=this.getCString(t);s.print(`${e}\n`)},this.env.vpc_outb=(t,e)=>this.iomgr.outb(t,e),this.env.vpc_inb=t=>this.iomgr.inb(t),this.env.vpc_irq=()=>e.checkIRQ()}setTimer(t){this.period=t}setSound(t){this.worker.postCommand("beep",t)}emit(t,e){const s=e.length;let i=this.vmem+t;for(let t=0;t<s;t++){const s=e[t];this._memory[i]=s,i++}}strlen(t){let e=0;for(let s=t;this._memory[s];s++)e++;return e}getCString(t){const e=this.strlen(t),s=new Uint8Array(this._memory.buffer,t,e);return new TextDecoder("utf-8").decode(s)}run(t){this.cpu=this.instance.exports.alloc_cpu(t),console.log(`CPU started (${t})`),this.cont()}cont(){this.period&&((new Date).valueOf()>this.lastTick+this.period&&this.pic.raiseIRQ(0),this.lastTick=(new Date).valueOf());const t=this.instance.exports.run(this.cpu);if(t)console.log(`CPU halted (${t})`);else{const t=(new Date).valueOf();let e=this.lastTick+this.period-t;e<1&&(e=1),setTimeout(()=>this.cont(),e)}}}(r,o,n),a=(new class{constructor(t,e){this.timer=e,this.cntModes=new Uint8Array(3),this.cntPhases=[0,0,0],this.cntValues=new Uint8Array(6),this.p0061_data=0,t.on(64,(t,e)=>this.outCntReg(0,e)),t.on(65,(t,e)=>this.outCntReg(1,e)),t.on(66,(t,e)=>this.outCntReg(2,e)),t.on(67,(t,e)=>{const s=e>>6&3;if(s<3&&(e>>4&3)>0)switch(this.cntModes[s]=e,this.cntPhases[s]=0,this.cntValues[2*s]=0,this.cntValues[2*s+1]=0,s){case 0:this.clearTimer();break;case 2:this.noteOff()}return!1}),t.on(97,(t,e)=>{const s=this.p0061_data;return this.p0061_data=e,2&(s^e)&&(2&e?this.noteOn():this.noteOff()),!1},t=>this.p0061_data)}outCntReg(t,e){if(1!=this.cntPhases[t])this.cntValues[2*t]=e,this.cntPhases[t]=1;else switch(this.cntValues[2*t+1]=e,this.cntPhases[t]=0,t){case 0:this.setTimer();break;case 2:2&this.p0061_data&&this.noteOn()}return!1}noteOn(){const t=1193181/this.getCounter(2);this.timer.setSound(t)}noteOff(){this.timer.setSound(0)}getCounter(t){let e=this.cntValues[2*t]+256*this.cntValues[2*t+1];return e||(e=65536),e}clearTimer(){this.timer.setTimer(0)}setTimer(){const t=Math.ceil(this.getCounter(0)/1193.181);this.timer.setTimer(t)}}(r,h),new class{constructor(t,e,s,i){this.pic=s,this.fifo_i=[],t.on(e,(t,e)=>{i.print(String.fromCharCode(e))},t=>this.fifo_i.length>0?this.fifo_i.shift():0)}onRX(t){this.fifo_i.push(255&t)}}(r,1016,o,n));console.log("Loading CPU..."),fetch("./vcpu.wasm").then(t=>{if(!t.ok)throw Error(t.statusText);return t.arrayBuffer()}).then(t=>WebAssembly.instantiate(t,h)).then(t=>(h.instance=t.instance,h.vmem=h.instance.exports._init(),console.log("Loading BIOS..."),fetch("./bios.bin"))).then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise((e,s)=>{const i=new FileReader;i.onloadend=()=>{e(i.result)},i.readAsArrayBuffer(t)})).then(t=>{const e=new Uint8Array(t),s=(e[0]|e[1]<<8)<<4;h.emit(s,e),n.postCommand("loaded",null)}).catch(t=>{console.error(t),n.print(t.toString())}),onmessage=t=>{switch(t.data.command){case"start":r.ioRedirectMap=t.data.ioRedirectMap,h.run(1);break;case"key":a.onRX(t.data.data);break;default:console.log("worker.onmessage",t.data)}}}]);