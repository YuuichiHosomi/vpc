!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){this.worker=t,this.obHandlers=[],this.owHandlers=[],this.ibHandlers=[],this.iwHandlers=[],this.ioRedirectMap=new Uint32Array(2048)}on(t,e,s){null!=e&&(this.obHandlers[65535&t]=e),null!=s&&(this.ibHandlers[65535&t]=s)}onw(t,e,s){null!=e&&(this.owHandlers[65535&t]=e),null!=s&&(this.iwHandlers[65535&t]=s)}isRedirectRequired(t){return 0!=(this.ioRedirectMap[t>>5]&1<<(31&t))}outb(t,e){try{const s=this.obHandlers[65535&t];s&&s(t,255&e)}catch(t){console.error("worker_outb()",t)}this.isRedirectRequired(t)&&this.worker.postCommand("outb",{port:t,data:e})}outw(t,e){try{const s=this.owHandlers[65535&t];s&&s(t,65535&e)}catch(t){console.error("worker_outw()",t)}}inb(t){const e=this.ibHandlers[65535&t];return e?255&e(t):255}inw(t){const e=this.iwHandlers[65535&t];return e?65535&e(t):65535}}class r{constructor(t){this.irq=[],this.phase=[0,0],this.IMR=new Uint8Array([255,255]),this.IRR=new Uint8Array(2),this.ISR=new Uint8Array(2),this.ICW=new Uint8Array(8),t.on(32,(t,e)=>this.writeOCR(0,e),t=>this.readOCR(0)),t.on(33,(t,e)=>this.writeIMR(0,e),t=>this.readIMR(0)),t.on(160,(t,e)=>this.writeOCR(1,e),t=>this.readOCR(1)),t.on(161,(t,e)=>this.writeIMR(1,e),t=>this.readIMR(1))}writeOCR(t,e){if(16&e)this.phase[t]=1,this.ICW[4*t]=e;else if(32==e)for(let e=0;e<8;e++){const s=1<<e;if(this.ISR[t]&s){this.ISR[t]&=~s,this.enqueue(0);break}}}readOCR(t){return this.ISR[t]}writeIMR(t,e){const s=this.phase[t]||0;s>0&&s<4?(this.ICW[4*t+s]=e,this.phase[t]=s<4?1+s:0):this.IMR[t]=e}readIMR(t){return this.IMR[t]}enqueue(t){for(let e=0;e<8;e++){if(this.irq.length)return;const s=1<<e;if(0==t&&e==this.ICW[0]&&0==(this.IMR[0]&s)){this.enqueue(1);break}if(this.ISR[t]&s)break;this.IRR[t]&s&&0==(this.IMR[t]&s)&&(this.IRR[t]&=~s,this.ISR[t]|=s,this.irq.push(8*t+e))}}raiseIRQ(t){t<8?0==t?this.irq.push(0):(this.IRR[0]|=1<<t,this.enqueue(0)):t<16&&(this.ISR[1]|=1<<t-8,this.IRR[0]|=this.ICW[2],this.enqueue(0))}dequeueIRQ(){const t=this.irq.shift();if(null!=t){const e=t>>3,s=7&t,i=1<<s;return this.ISR[e]|=i,248&this.ICW[4*e+1]|s}return 0}}class n{constructor(t){this.env=t,this.cntModes=new Uint8Array(3),this.cntPhases=[0,0,0],this.cntValues=new Uint8Array(6),this.p0061_data=0,t.iomgr.on(64,(t,e)=>this.outCntReg(0,e)),t.iomgr.on(65,(t,e)=>this.outCntReg(1,e)),t.iomgr.on(66,(t,e)=>this.outCntReg(2,e)),t.iomgr.on(67,(t,e)=>{const s=e>>6&3;if(s<3&&(e>>4&3)>0)switch(this.cntModes[s]=e,this.cntPhases[s]=0,this.cntValues[2*s]=0,this.cntValues[2*s+1]=0,s){case 0:this.clearTimer();break;case 2:this.noteOff()}return!1}),t.iomgr.on(97,(t,e)=>{const s=this.p0061_data;return this.p0061_data=e,2&(s^e)&&(2&e?this.noteOn():this.noteOff()),!1},t=>this.p0061_data)}outCntReg(t,e){if(1!=this.cntPhases[t])this.cntValues[2*t]=e,this.cntPhases[t]=1;else switch(this.cntValues[2*t+1]=e,this.cntPhases[t]=0,t){case 0:this.setTimer();break;case 2:2&this.p0061_data&&this.noteOn()}}noteOn(){const t=1193181/this.getCounter(2);this.env.setSound(t)}noteOff(){this.env.setSound(0)}getCounter(t){let e=this.cntValues[2*t]+256*this.cntValues[2*t+1];return e||(e=65536),e}clearTimer(){this.env.setTimer(0)}setTimer(){this.env.setTimer(this.getCounter(0)/1193.181)}}class h{constructor(t,e,s){this.env=t,this.irq=s,this.fifo_o=[],this.fifo_i=[],t.iomgr.on(e,(t,e)=>this.fifo_o.push(e),t=>this.fifo_i.shift()||0),t.iomgr.on(e+1,(t,e)=>this.IER=e,t=>this.IER),t.iomgr.on(e+5,void 0,t=>32|(this.fifo_i.length>0?1:0))}dequeueTX(){const t=this.fifo_o.slice();return this.fifo_o=[],t}onRX(t){this.fifo_i.push(255&t),1&this.IER&&this.env.pic.raiseIRQ(this.irq)}}class a{constructor(t){this.ram=new Uint8Array(256),t.iomgr.on(112,(t,e)=>this.index=e,t=>this.index),t.iomgr.on(113,(t,e)=>this.writeRTC(e),t=>this.readRTC())}writeRTC(t){this.ram[this.index]=t}readRTC(){const t=t=>{return t%10+((t/10|0)<<4)},e=new Date;switch(this.index){case 0:return t(e.getSeconds());case 2:return t(e.getMinutes());case 4:return t(e.getHours());case 6:return e.getDay();case 7:return t(e.getDate());case 8:return t(1+e.getMonth());case 9:return t(e.getFullYear()%100);case 50:return t(e.getFullYear()/100|0);default:return this.ram[this.index]}}}const o=111,c={AltLeft:56,AltRight:57400,ControlLeft:29,ControlRight:57373,ShiftLeft:42,ShiftRight:54,KeyA:30,KeyB:48,KeyC:46,KeyD:32,KeyE:18,KeyF:33,KeyG:34,KeyH:35,KeyI:23,KeyJ:36,KeyK:37,KeyL:38,KeyM:50,KeyN:49,KeyO:24,KeyP:25,KeyQ:16,KeyR:19,KeyS:31,KeyT:20,KeyU:22,KeyV:47,KeyW:17,KeyX:45,KeyY:21,KeyZ:44},u=[0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,0,0,0,0,0,0,0,1,0,0,0,0,57,0,0,0,0,75,72,77,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,0,0,0,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,111,0,0,0,0,0,111,111,111,111,111,111,111,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,111,111,111,111,0,0,0,111,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const d=100,l=1,m=655360,f=753664,g=45249,p=0,y=1,b=2,w=3,_=4,R=5,v=6,C=7,I=8,S=9,T=1;const x=128,A=4,k=6;class B{constructor(t,e){this.env=t,this.outputBuffer=[],this.inputBuffer=[],t.iomgr.on(e,(t,e)=>this.uartOut(e),t=>this.inputBuffer.shift()||0),t.iomgr.on(e+1,(t,e)=>{switch(e){case 255:this.lastStatus=null,this.outputBuffer=[],this.inputBuffer=[254];break;case 63:console.log("mpu401: enter to uart mode")}},t=>this.inputBuffer.length>0?0:128)}uartOut(t){if(0!=(128&t))t<240?(this.lastStatus=t,this.outputBuffer=[t]):t>=248?this.midiOut([t]):247==t?(this.outputBuffer.length>=5&&240==this.outputBuffer[0]&&(this.outputBuffer.push(t),this.midiOut(this.outputBuffer)),this.outputBuffer=[]):(this.lastStatus=null,this.outputBuffer=[t]);else{if(0==this.outputBuffer.length){if(null==this.lastStatus)return;this.outputBuffer.push(this.lastStatus)}switch(this.outputBuffer.push(t),240&this.outputBuffer[0]){case 240:break;case 192:case 208:2==this.outputBuffer.length&&(this.midiOut(this.outputBuffer),this.outputBuffer=[]);break;default:3==this.outputBuffer.length&&(this.midiOut(this.outputBuffer),this.outputBuffer=[])}}}midiOut(t){this.env.worker.postCommand("midi",t)}}const D=self;const P=new class{print(t){this.postCommand("write",t)}postCommand(t,e){D.postMessage({command:t,data:e})}hasClass(t){return"function"==typeof D[t]}},O=new class{constructor(t){this.worker=t,this.period=0,this.lastTick=(new Date).valueOf(),this.env={memoryBase:0,memory:new WebAssembly.Memory({initial:1,maximum:1030})},this._memory=new Uint8Array(this.env.memory.buffer),this.env.println=t=>{const e=this.getCString(t);console.log(e)},this.env.vpc_outb=(t,e)=>this.iomgr.outb(t,e),this.env.vpc_inb=t=>this.iomgr.inb(t),this.env.vpc_outw=(t,e)=>this.iomgr.outw(t,e),this.env.vpc_inw=t=>this.iomgr.inw(t),this.env.vpc_irq=()=>this.pic.dequeueIRQ(),this.env.TRAP_NORETURN=()=>{throw new Error("UNEXPECTED CONTROL FLOW")},this.env.vpc_grow=t=>{const e=this.env.memory.grow(t);return this._memory=new Uint8Array(this.env.memory.buffer),e},this.iomgr=new i(t),this.pic=new r(this.iomgr),this.pit=new n(this),this.rtc=new a(this),this.uart=new h(this,1016,4),this.iomgr.onw(0,void 0,t=>65535*Math.random()),this.iomgr.onw(64512,void 0,t=>this.memoryConfig[0]),this.iomgr.onw(64514,void 0,t=>this.memoryConfig[1])}loadCPU(t){this.instance=t}fetchBIOS(t){this.bios=t}initMemory(t){console.log(`Memory: ${t}KB OK`),this.memoryConfig=t<1024?new Uint16Array([t,0]):new Uint16Array([640,t-1024]),this.vmem=this.instance.exports._init((t+1023)/1024),this.loadBIOS()}loadBIOS(){const t=(this.bios[0]|this.bios[1]<<8)<<4;this.dmaWrite(t,this.bios)}setTimer(t){this.period=t}setSound(t){this.worker.postCommand("beep",t)}emit(t,e){const s=e.length;let i=this.vmem+t;for(let t=0;t<s;t++){const s=e[t];if("string"==typeof s)for(let t=0;t<s.length;t++)this._memory[i]=s.charCodeAt(t),i++;else{if("number"!=typeof s)throw`Unexpected type ${typeof s}`;this._memory[i]=s,i++}}}dmaWrite(t,e){const s=new Uint8Array(e);this._memory.set(s,this.vmem+t)}dmaRead(t,e){const s=this.vmem+t;return this._memory.slice(s,s+e)}strlen(t){let e=0;for(let s=t;this._memory[s];s++)e++;return e}getCString(t){const e=this.strlen(t),s=new Uint8Array(this._memory.buffer,t,e);return this.worker.hasClass("TextDecoder")?new TextDecoder("utf-8").decode(s):String.fromCharCode(...s)}reset(t){this.instance&&(console.log(`CPU restarted (${t})`),this.loadBIOS(),this.instance.exports.reset(this.cpu,t),this.isPausing=!1,this.isRunning&&!this.isDebugging||(this.isDebugging=!1,this.isRunning=!0,this.cont()))}run(t){this.cpu=this.instance.exports.alloc_cpu(t),this.regmap=JSON.parse(this.getCString(this.instance.exports.debug_get_register_map(this.cpu))),console.log(`CPU started (${t})`),this.isRunning=!0,this.cont()}cont(){if(this.period>0){const t=(new Date).valueOf();for(let e=this.lastTick+this.period;t>=e;e+=this.period)this.pic.raiseIRQ(0),this.lastTick=e}const t=this.instance.exports.run(this.cpu);if(this.dequeueUART(),t>1)this.isRunning=!1,console.log(`CPU halted (${t.toString(16)})`);else if(this.isDebugging)this.instance.exports.debug_dump(this.cpu),this.isPausing=!0;else{let e;if(t>0){const t=(new Date).valueOf();(e=this.lastTick+this.period-t)<0&&(e=0)}else e=1;setTimeout(()=>this.cont(),e)}}dequeueUART(){const t=this.uart.dequeueTX();t.length>0&&this.worker.print(String.fromCharCode(...t))}nmi(){!this.isRunning||this.isPausing?(this.instance.exports.step(this.cpu),this.instance.exports.debug_dump(this.cpu)):this.isDebugging=!0,this.dequeueUART()}setReg(t,e){const s=this.regmap[t];if(!s)throw new Error(`Unexpected Regsiter Name: ${t}`);new Uint32Array(this.env.memory.buffer,s,1)[0]=e}getReg(t){const e=this.regmap[t];if(!e)throw new Error(`Unexpected Regsiter Name: ${t}`);return new Uint32Array(this.env.memory.buffer,e,1)[0]}dump(t){const e=t=>("000000"+t.toString(16)).substr(-6),s=t=>("00"+t.toString(16)).substr(-2);let i=[];for(let r=0;r<16;r++){const n=t+16*r;let h=[e(n)],a=[];for(let t=0;t<16;t++){const e=this._memory[this.vmem+n+t];h.push(s(e)),e>=32&&e<127?a.push(String.fromCharCode(e)):a.push(".")}h.push(a.join("")),i.push(h.join(" "))}console.log(i.join("\n"))}get_vram_signature(t,e){return this.instance.exports.get_vram_signature(t,e)}}(P),U=new class{constructor(t){this.env=t,this.o_fifo=[],this.i_fifo=[],t.iomgr.on(96,(t,e)=>{},t=>this.o_fifo.shift()||0),t.iomgr.on(100,(t,e)=>this.command(e),t=>0|(this.o_fifo.length>0?1:0)|(this.i_fifo.length>0?2:0)),t.iomgr.onw(100,void 0,t=>this.o_fifo.shift()||0)}command(t){}onKey(t){const{type:e,key:s,code:i,keyCode:r,ctrlKey:n,altKey:h}=t;let a=0,d=c[i];d||(d=u[r]),d>57344&&d<57471&&(d&=127,a=224);let l=1==s.length?s.charCodeAt(0):0;if(n&&l>=64&&l<=128&&(l&=31),l)d|=l<<8;else switch(r){case 8:case 9:case 13:case 27:d|=r<<8}switch(0==d&&0!=l&&(d=o),e){case"keydown":break;case"keyup":d|=128}127&d&&(a&&this.o_fifo.push(a),this.o_fifo.push(d),this.env.pic.raiseIRQ(1))}}(O),M=new class{constructor(t){this.env=t,this.bytesPerSector=512,this.n_heads=2,this.PTR=new Uint16Array(2),t.iomgr.onw(64768,(t,e)=>{switch(e){case 0:this.status=0,this.CNT=this.driveType,this.CYL=this.n_cylinders,this.HEAD=this.n_heads,this.SEC=this.n_sectors;break;case 1:this.status=this.readSectors();break;case 2:this.status=this.writeSectors()}},t=>this.status),t.iomgr.onw(64770,(t,e)=>this.PTR[0]=e,t=>this.PTR[0]),t.iomgr.onw(64772,(t,e)=>this.PTR[1]=e,t=>this.PTR[1]),t.iomgr.on(64774,(t,e)=>this.CNT=e,t=>this.CNT),t.iomgr.on(64775,(t,e)=>this.HEAD=e,t=>this.HEAD),t.iomgr.on(64776,(t,e)=>this.SEC=e,t=>this.SEC),t.iomgr.on(64777,(t,e)=>this.CYL=e,t=>this.CYL)}readSectors(){if(0==this.maxLBA)return x;if(this.status==k)return k;if(!this.image||this.SEC<1||this.SEC>this.n_sectors||this.HEAD>=this.n_heads||this.CYL>=this.n_cylinders)return console.log(`vfd_read: BAD SECTOR [C:${this.CYL} H:${this.HEAD} R:${this.SEC}]`),A;let t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16),s=this.CNT;for(;s>0;s--,t++){if(t>=this.maxLBA)return A;const i=new Uint8Array(this.image.buffer,t*this.bytesPerSector,this.bytesPerSector);this.env.dmaWrite(e,i),e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=s}return this.CNT=s,0}writeSectors(){if(0==this.maxLBA)return x;if(this.status==k)return k;if(!this.image||this.SEC<1||this.SEC>this.n_sectors||this.HEAD>=this.n_heads||this.CYL>=this.n_cylinders)return console.log(`vfd_write: BAD SECTOR [C:${this.CYL} H:${this.HEAD} R:${this.SEC}]`),A;let t=this.SEC-1+(this.HEAD+this.CYL*this.n_heads)*this.n_sectors,e=this.PTR[0]+(this.PTR[1]<<16),s=this.CNT;for(;s>0;s--,t++){if(t>=this.maxLBA)return A;const i=this.env.dmaRead(e,this.bytesPerSector),r=t*this.bytesPerSector;for(let t=0;t<this.bytesPerSector;t++)this.image[r+t]=i[t];e+=this.bytesPerSector,this.PTR[0]=e,this.PTR[1]=e,this.CNT=s}return this.CNT=s,0}attachImage(t){if(null!=t)if(512==t.byteLength)this.image=new Uint8Array(t),this.maxLBA=1,this.driveType=4,this.n_heads=2,this.n_sectors=18,this.n_cylinders=80,console.log(`vfd_attach: BootSector ${this.bytesPerSector}`);else{const e=t.byteLength/1024;let s,i=2,r=0;switch(e){case 160:i=1,s=8;break;case 180:i=1,s=9;break;case 320:s=8;break;case 360:r=1,s=9;break;case 640:s=8;break;case 720:r=3,s=9;break;case 1200:r=2,s=15;break;case 1440:r=4,s=18;break;case 2880:r=6,s=36;break;default:throw new Error("Unexpected image size")}this.image=new Uint8Array(t),this.maxLBA=this.image.byteLength/this.bytesPerSector,this.driveType=r,this.n_heads=i,this.n_sectors=s,this.n_cylinders=this.maxLBA/this.n_heads/this.n_sectors,console.log(`vfd_attach: ${e}KB LBA:${this.maxLBA} [C:${this.n_cylinders} H:${this.n_heads} R:${this.n_sectors}]`)}else this.maxLBA=0,this.driveType=4,this.n_heads=2,this.n_sectors=18,this.n_cylinders=80,console.log("vfd_attach: EMPTY");this.status=k}}(O);new class{constructor(t){this.env=t,this.pal_u32=new Uint32Array(256),this.pal_u8=new Uint8Array(this.pal_u32.buffer);for(let t=0;t<256;t++)this.pal_u32[t]=4278190080;this.crtcData=new Uint8Array(24),this.attrData=new Uint8Array(32),this.bgaData=new Uint16Array(10),this.bgaData[0]=g,this._vtrace=0,t.iomgr.on(948,(t,e)=>this.crtcIndex=e,t=>this.crtcIndex),t.iomgr.on(949,(t,e)=>this.crtcDataWrite(this.crtcIndex,e),t=>this.crtcData[this.crtcIndex]),t.iomgr.on(980,(t,e)=>this.crtcIndex=e,t=>this.crtcIndex),t.iomgr.on(981,(t,e)=>this.crtcDataWrite(this.crtcIndex,e),t=>this.crtcData[this.crtcIndex]),t.iomgr.on(954,void 0,t=>this.vtrace()),t.iomgr.on(986,void 0,t=>this.vtrace()),t.iomgr.on(960,(t,e)=>this.attrIndex=e,t=>this.attrIndex),t.iomgr.on(961,(t,e)=>{switch(this.attrIndex){case 16:this.attrData[this.attrIndex]=this.setAttrMode(e);break;default:this.attrData[this.attrIndex]=e}},t=>this.attrData[this.attrIndex]),t.iomgr.on(967,(t,e)=>{this.pal_read_index=4*e}),t.iomgr.on(968,(t,e)=>{this.pal_index=4*e}),t.iomgr.on(969,(t,e)=>{let s=this.pal_index;if(this.pal_u8[s]=(63&e)<<2|(48&e)>>4,3==(3&++s)){const t=s>>2;this.env.worker.postCommand("pal",[t,this.pal_u32[t]]),s++}this.pal_index=1023&s},t=>{let e=this.pal_read_index;const s=this.pal_u8[e]>>2;return 3==(3&++e)&&e++,this.pal_read_index=1023&e,s}),t.iomgr.onw(462,(t,e)=>this.bgaIndex=e,t=>this.bgaIndex),t.iomgr.onw(463,(t,e)=>{switch(this.bgaIndex){case p:break;case y:case b:case w:case v:case C:this.bgaData[this.bgaIndex]=e;break;case _:this.bgaData[this.bgaIndex]=this.bgaSetEnabled(e)}},t=>{switch(this.bgaIndex){case p:case y:case b:case w:case _:case R:case v:case C:case I:case S:return this.bgaData[this.bgaIndex];default:return 65535}})}vtrace(){return this._vtrace^=8,this._vtrace}crtcDataWrite(t,e){this.crtcData[this.crtcIndex]=e}packedMode(t,e,s){return 4095&t|(4095&e)<<12|s<<24}setAttrMode(t){return 64&t?(this.vram_base=m,this.vram_size=64e3,this.setMode([320,200],[640,400],8,l)):1&t||(this.vram_base=f,this.vram_size=4e3,this.setMode([640,400],[640,400],4,0)),t}bgaSetEnabled(t){if(t==T){this.clearTimer();const t=this.bgaData[y],e=this.bgaData[b],s=this.bgaData[v],i=this.bgaData[C],r=this.bgaData[w];let n=!1;switch(this.packedMode(t,e,r)){case this.packedMode(320,200,8):this.vram_base=m,this.vram_size=64e3,n=!0;break;case this.packedMode(640,400,8):this.vram_base=m,this.vram_size=65536,n=!0}return n?(this.setMode([t,e],[i,s],r,l),1):0}return this.clearTimer(),this.vram_sign=NaN,0}updateCursor(){let t=-1;0==(32&this.crtcData[10])&&(t=this.crtcData[14]<<8|this.crtcData[15]),this.env.worker.postCommand("vga_cursor",t)}setMode(t,e,s,i){this.clearTimer(),this.env.worker.postCommand("vga_mode",{dim:t,vdim:e,bpp:s,mode:i}),this.timer=setInterval(()=>this.transferVGA(),d)}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}transferVGA(){this.updateCursor();const t=this.env.get_vram_signature(this.vram_base,this.vram_size);if(this.vram_sign!=t){this.vram_sign=t;const e=this.env.dmaRead(this.vram_base,this.vram_size);this.env.worker.postCommand("vga",e)}}}(O);let E;self.env=O,self.ps2=U,async function(){console.log("Loading CPU..."),await fetch("./vcpu.wasm").then(t=>{if(!t.ok)throw Error(t.statusText);return t.arrayBuffer()}).then(t=>WebAssembly.instantiate(t,O)).then(t=>O.loadCPU(t.instance)),console.log("Loading BIOS..."),await fetch("./bios.bin").then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise(e=>{const s=new FileReader;s.onloadend=()=>{e(s.result)},s.readAsArrayBuffer(t)})).then(t=>{const e=new Uint8Array(t);O.fetchBIOS(e)}),P.postCommand("loaded",null)}();const K=async(t,e)=>{e&&await(async t=>(console.log(`Loading image ${t}`),fetch(t).then(t=>{if(!t.ok)throw Error(t.statusText);return t.blob()}).then(t=>new Promise((e,s)=>{const i=new FileReader;i.onloadend=()=>{e(i.result)},i.readAsArrayBuffer(t)})).then(t=>{M.attachImage(t)}).catch(t=>console.error(t))))(e),O.run(t)},L=t=>{const e=O.getReg(t);P.postCommand("regResult",("00000000"+e.toString(16)).slice(-8))};onmessage=t=>{switch(t.data.command){case"start":O.initMemory(t.data.mem),O.iomgr.ioRedirectMap=t.data.ioRedirectMap,t.data.midi&&(E=new B(O,816)),setTimeout(()=>K(t.data.gen,t.data.imageName),100);break;case"reset":O.reset(t.data.gen);break;case"key":U.onKey(t.data.data);break;case"nmi":O.nmi(),L(t.data.regName);break;case"readReg":L(t.data.regName);break;case"dump":O.dump(t.data.address);break;case"attach":try{M.attachImage(t.data.blob)}catch(t){P.postCommand("alert",t.toString())}break;default:console.log("worker.onmessage",t.data)}}}]);